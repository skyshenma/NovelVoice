<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelVoice Studio</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Frameworks -->
    <script>
        // Suppress Tailwind CDN production warning
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Design System & Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        bg: {
                            DEFAULT: '#020617', // Slate 950
                            card: '#0f172a',    // Slate 900
                            elevated: '#1e293b', // Slate 800
                        },
                        border: {
                            DEFAULT: '#1e293b', // Slate 800
                            hover: '#334155',   // Slate 700
                        },
                        primary: {
                            DEFAULT: '#22c55e', // Green 500
                            hover: '#16a34a',   // Green 600
                            glow: 'rgba(34, 197, 94, 0.5)',
                        },
                        accent: {
                            DEFAULT: '#6366f1', // Indigo 500
                            glow: 'rgba(99, 102, 241, 0.5)',
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px var(--tw-shadow-color)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Utilities */
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.4) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            border-color: rgba(148, 163, 184, 0.1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* Utils */
        .text-glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .active-nav {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
            border-left: 2px solid #22c55e;
            color: #4ade80;
        }

        [v-cloak] {
            display: none;
        }

        /* Toast Transitions */
        .toast-enter-active,
        .toast-leave-active {
            transition: all 0.3s ease;
        }

        .toast-enter-from {
            opacity: 0;
            transform: translateX(30px) scale(0.9);
        }

        .toast-leave-to {
            opacity: 0;
            transform: translateY(-30px);
        }
    </style>
</head>

<body class="antialiased min-h-screen relative selection:bg-primary selection:text-white">

    <!-- Background Effects -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div
            class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/5 rounded-full blur-[120px] animate-pulse-slow">
        </div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-accent/5 rounded-full blur-[120px] animate-pulse-slow"
            style="animation-delay: 2s;"></div>
    </div>

    <div id="app" v-cloak class="relative z-10 flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside
            class="w-64 flex-shrink-0 border-r border-border glass flex flex-col transition-transform duration-300 md:translate-x-0 fixed md:relative z-30 h-full backdrop-blur-xl"
            :class="showMobileSidebar ? 'translate-x-0' : '-translate-x-full'">

            <!-- Logo -->
            <div class="h-16 flex items-center px-6 border-b border-white/5">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-green-600 flex items-center justify-center shadow-lg shadow-primary-glow mr-3">
                    <i class="ri-voiceprint-line text-white text-lg"></i>
                </div>
                <h1
                    class="text-lg font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                    NovelVoice</h1>
            </div>

            <!-- Nav -->
            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <div class="px-3 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">资源库</div>

                <a href="#" @click.prevent="viewMode = 'list'"
                    class="flex items-center px-3 py-2.5 rounded-lg transition-all duration-200 group"
                    :class="viewMode === 'list' && !showSettings ? 'bg-white/5 text-primary' : 'text-gray-400 hover:text-gray-200 hover:bg-white/5'">
                    <i class="ri-book-read-line text-xl mr-3 transition-colors"
                        :class="viewMode === 'list' && !showSettings ? 'text-primary' : 'text-gray-500 group-hover:text-gray-300'"></i>
                    <span class="font-medium">我的书籍</span>
                </a>

                <a href="#" @click.prevent="openFileManager(null)"
                    class="flex items-center px-3 py-2.5 rounded-lg transition-all duration-200 text-gray-400 hover:text-gray-200 hover:bg-white/5 group">
                    <i class="ri-folder-music-line text-xl mr-3 text-gray-500 group-hover:text-gray-300"></i>
                    <span class="font-medium">文件管理</span>
                </a>

                <div class="px-3 mt-8 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">控制台</div>

                <a href="#" @click.prevent="showLogs = true"
                    class="flex items-center px-3 py-2.5 rounded-lg transition-all duration-200 text-gray-400 hover:text-gray-200 hover:bg-white/5 group">
                    <i class="ri-terminal-box-line text-xl mr-3 text-gray-500 group-hover:text-gray-300"></i>
                    <span class="font-medium">系统日志</span>
                    <span class="ml-auto w-2 h-2 rounded-full"
                        :class="wsStatus === 'connected' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'"></span>
                </a>

                <a href="#" @click.prevent="showSettings = true"
                    class="flex items-center px-3 py-2.5 rounded-lg transition-all duration-200 text-gray-400 hover:text-gray-200 hover:bg-white/5 group">
                    <i class="ri-settings-4-line text-xl mr-3 text-gray-500 group-hover:text-gray-300"></i>
                    <span class="font-medium">全局配置</span>
                </a>
            </nav>

            <!-- Status Footer -->
            <div class="p-4 border-t border-white/5 bg-black/20">
                <div class="flex items-center gap-3">
                    <!-- Version Info with Tooltip logic -->
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium text-gray-300">v{{ versionInfo?.app_version || '1.0.0' }}</div>
                        <div class="text-[10px] text-gray-500 truncate">Engine: {{ versionInfo?.engine_version ||
                            'Unknown' }}</div>
                    </div>
                    <button @click="checkVersion"
                        class="p-1.5 rounded-md hover:bg-white/10 text-gray-400 transition-colors" title="检查更新">
                        <i class="ri-refresh-line" :class="{'animate-spin': checkingVersion}"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div v-if="showMobileSidebar" @click="showMobileSidebar = false"
            class="fixed inset-0 bg-black/80 z-20 md:hidden backdrop-blur-sm"></div>

        <!-- Main Content Wrapper -->
        <main class="flex-1 flex flex-col relative overflow-hidden min-w-0 bg-bg">
            <!-- HEADER PLACEHOLDER -->
            <header class="h-16 border-b border-border glass flex items-center justify-between px-6 sticky top-0 z-10">
                <!-- Mobile Toggle -->
                <button @click="showMobileSidebar = true" class="md:hidden p-2 text-gray-400 hover:text-white">
                    <i class="ri-menu-2-line text-xl"></i>
                </button>

                <!-- Breadcrumbs/Title -->
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-semibold text-gray-100 flex items-center gap-2">
                        <span v-if="viewMode === 'detail'" @click="viewMode='list'"
                            class="cursor-pointer hover:text-primary transition-colors flex items-center gap-1 text-gray-400 hover:underline">
                            <i class="ri-arrow-left-s-line"></i> 返回
                        </span>
                        <span v-if="viewMode === 'detail'" class="text-gray-600">/</span>
                        <span>{{ viewMode === 'list' ? '我的书架' : currentBook?.name }}</span>
                    </h2>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-3">
                    <button @click="fileInput.click()"
                        class="flex items-center gap-2 px-4 py-2 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/20 rounded-lg transition-all text-sm font-medium hover:shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                        <i class="ri-upload-cloud-2-line"></i>
                        <span class="hidden sm:inline">上传书籍</span>
                    </button>
                    <input type="file" ref="fileInput" @change="handleFileSelect" accept=".txt,.epub,.mobi"
                        class="hidden">
                </div>
            </header>

            <!-- CONTENT SCROLL AREA -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth">

                <!-- Book List View -->
                <div v-if="viewMode === 'list'" class="max-w-7xl mx-auto space-y-8 animate-fade-in relative">

                    <!-- Stats / Welcome -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div
                            class="p-6 rounded-2xl bg-gradient-to-br from-bg-card to-bg-elevated border border-white/5 relative overflow-hidden group">
                            <div class="relative z-10">
                                <h3 class="text-gray-400 text-sm font-medium mb-1">我的藏书</h3>
                                <div class="text-3xl font-bold text-white tracking-tight font-mono">{{ books.length }}
                                    <span class="text-sm font-normal text-gray-500">本</span>
                                </div>
                            </div>
                            <div
                                class="absolute right-0 bottom-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="ri-book-open-line text-6xl"></i>
                            </div>
                        </div>

                        <!-- Quick Actions / Drop Zone Hint -->
                        <div class="col-span-1 md:col-span-2 p-6 rounded-2xl border border-dashed border-gray-700 bg-white/5 flex items-center justify-center text-gray-400 hover:border-primary/50 hover:bg-primary/5 transition-all cursor-pointer group"
                            @click="fileInput.click()" @drop.prevent="handleDrop" @dragover.prevent>
                            <div class="text-center">
                                <i
                                    class="ri-upload-cloud-2-line text-3xl mb-2 text-gray-500 group-hover:text-primary transition-colors"></i>
                                <p class="text-sm">拖拽文件到此处或 <span class="text-primary group-hover:underline">点击上传</span>
                                </p>
                                <p class="text-xs text-gray-600 mt-1">支持 .txt, .epub, .mobi</p>
                            </div>
                        </div>
                    </div>

                    <!-- Books Grid -->
                    <div v-if="books.length > 0"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div v-for="book in books" :key="book.name"
                            class="group relative bg-bg-card hover:bg-bg-elevated border border-border hover:border-border-hover rounded-2xl p-5 transition-all duration-300 hover:shadow-2xl hover:shadow-black/50 hover:-translate-y-1">

                            <!-- Menu Button -->
                            <div
                                class="absolute top-4 right-4 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click.stop="openProductContextMenu(book, $event)"
                                    class="p-1.5 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white">
                                    <i class="ri-more-2-fill"></i>
                                </button>
                            </div>

                            <!-- Icon -->
                            <div class="mb-5 flex items-start justify-between">
                                <div
                                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-gray-800 to-gray-900 border border-white/5 flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
                                    <i
                                        class="ri-book-mark-fill text-2xl bg-clip-text text-transparent bg-gradient-to-br from-primary to-emerald-300"></i>
                                </div>
                                <div v-if="book.is_processing"
                                    class="flex items-center gap-1 bg-blue-500/10 border border-blue-500/20 px-2 py-1 rounded text-[10px] text-blue-400">
                                    <i class="ri-loader-4-line animate-spin"></i> 处理中
                                </div>
                            </div>

                            <!-- Info -->
                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-gray-100 truncate mb-1" :title="book.name">{{
                                    book.name }}</h3>
                                <div class="flex items-center gap-3 text-xs text-gray-500 font-mono">
                                    <span>{{ book.total }} 章节</span>
                                    <span class="w-1 h-1 rounded-full bg-gray-700"></span>
                                    <span>{{ formatFileSize(book.size || 0) }}</span>
                                </div>
                            </div>

                            <!-- Progress -->
                            <div class="space-y-2 mb-5">
                                <div class="flex justify-between text-xs text-gray-400">
                                    <span>进度</span>
                                    <span class="font-mono text-primary">{{ progressPercent(book) }}%</span>
                                </div>
                                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-primary to-emerald-400 relative"
                                        :style="{ width: progressPercent(book) + '%' }">
                                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-white/50 blur-[1px]"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Packing Progress -->
                            <div v-if="packingProgress[book.name]" class="mb-4 animate-pulse">
                                <div class="flex justify-between text-xs text-blue-400 mb-1">
                                    <span class="flex items-center gap-1"><i class="ri-archive-line animate-spin"></i>
                                        打包中...</span>
                                    <span class="font-mono">{{ packingProgress[book.name] }}%</span>
                                </div>
                                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 transition-all duration-300 relative"
                                        :style="{ width: packingProgress[book.name] + '%' }">
                                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-white/50 blur-[1px]"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="grid grid-cols-2 gap-2 mt-auto">
                                <button @click="enterDetail(book)"
                                    class="col-span-2 py-2.5 rounded-lg bg-white/5 hover:bg-primary hover:text-white text-gray-300 border border-white/5 hover:border-primary/50 transition-all font-medium text-sm flex items-center justify-center gap-2 group/btn">
                                    进入控制台
                                    <i
                                        class="ri-arrow-right-line transition-transform group-hover/btn:translate-x-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DETAIL_INJECTION_POINT -->
                <div v-if="viewMode === 'detail' && currentBook"
                    class="max-w-7xl mx-auto space-y-6 animate-fade-in pb-20">

                    <!-- Control Bar (Glass Sticky) -->
                    <div class="glass-card rounded-2xl p-5 sticky top-0 z-30 shadow-2xl shadow-black/50">
                        <div class="flex flex-col lg:flex-row gap-6">

                            <!-- Left: Config -->
                            <div class="flex-1 space-y-4">
                                <!-- Voice Select -->
                                <div class="relative group">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <i class="ri-user-voice-line"></i>
                                    </div>
                                    <select v-model="config.voice"
                                        class="w-full bg-bg-elevated border border-border rounded-lg py-2.5 pl-10 pr-4 text-sm text-gray-200 focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none transition-all">
                                        <option v-for="v in voices" :key="v.ShortName" :value="v.ShortName">
                                            {{ v.LocalName || v.ShortName }} ({{ v.Gender }})
                                        </option>
                                    </select>
                                    <div
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">
                                        <i class="ri-arrow-down-s-line"></i>
                                    </div>
                                </div>

                                <!-- Sliders Grid -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <!-- Rate -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>语速</span>
                                            <span class="font-mono text-primary">{{ rateVal }}%</span>
                                        </div>
                                        <input type="range" v-model.number="rateVal" min="-50" max="100"
                                            class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
                                    </div>
                                    <!-- Volume -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>音量</span>
                                            <span class="font-mono text-primary">{{ volumeVal }}%</span>
                                        </div>
                                        <input type="range" v-model.number="volumeVal" min="-50" max="50"
                                            class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
                                    </div>
                                    <!-- Pitch -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>音调</span>
                                            <span class="font-mono text-primary">{{ pitchVal }}Hz</span>
                                        </div>
                                        <input type="range" v-model.number="pitchVal" min="-50" max="50"
                                            class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Actions -->
                            <div
                                class="flex flex-col justify-between gap-4 lg:w-72 lg:border-l lg:border-white/5 lg:pl-6">
                                <!-- Main Play Controls -->
                                <div class="grid grid-cols-2 gap-2">
                                    <button @click="testVoice" :disabled="previewing"
                                        class="px-4 py-2 bg-bg-elevated hover:bg-white/10 border border-border rounded-lg text-sm text-gray-300 flex items-center justify-center gap-2 transition-all">
                                        <i class="ri-play-circle-line" :class="previewing ? 'animate-spin' : ''"></i> 试听
                                    </button>
                                    <button @click="startSelected"
                                        class="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-lg text-sm font-bold shadow-lg shadow-primary/20 flex items-center justify-center gap-2 transition-all hover:scale-105 active:scale-95">
                                        <i class="ri-play-fill text-lg"></i> 开始生成
                                    </button>
                                </div>

                                <!-- Secondary Actions -->
                                <div class="flex items-center gap-2">
                                    <button v-if="currentTaskStatus.is_running" @click="pauseTask"
                                        class="flex-1 py-1.5 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 border border-yellow-500/20 rounded text-xs flex items-center justify-center gap-1 transition-all">
                                        <i class="ri-pause-circle-line"></i> 暂停
                                    </button>
                                    <button v-else-if="currentTaskStatus.is_paused" @click="resumeTask"
                                        class="flex-1 py-1.5 bg-green-500/10 hover:bg-green-500/20 text-green-500 border border-green-500/20 rounded text-xs flex items-center justify-center gap-1 transition-all">
                                        <i class="ri-play-fill"></i> 继续
                                    </button>
                                    <button @click="mergeAudio"
                                        class="flex-1 py-1.5 bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 border border-purple-500/20 rounded text-xs flex items-center justify-center gap-1 transition-all"
                                        title="合并音频">
                                        <i class="ri-merge-cells-horizontal"></i> 合并
                                    </button>
                                    <button @click="openFileManager(currentBook.name)"
                                        class="flex-1 py-1.5 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 rounded text-xs flex items-center justify-center gap-1 transition-all"
                                        title="文件管理">
                                        <i class="ri-folder-music-line"></i> 文件
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter / Batch Bar -->
                    <div
                        class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-bg-card/50 p-3 rounded-xl border border-white/5">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button @click="toggleSelectAll"
                                class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1"
                                :class="isAllSelected ? 'bg-primary/20 text-primary' : 'bg-white/5 text-gray-400 hover:text-white'">
                                <i :class="isAllSelected ? 'ri-checkbox-circle-fill' : 'ri-checkbox-circle-line'"></i>
                                全选
                            </button>
                            <div class="h-4 w-px bg-gray-700 mx-1"></div>
                            <input v-model="rangeInput" @change="applyRangeSelection" placeholder="例如: 1-10, 15"
                                class="bg-black/20 border border-white/10 rounded px-2.5 py-1 text-xs text-gray-300 w-32 focus:border-primary/50 outline-none transition-colors">
                            <button @click="applyRangeSelection"
                                class="text-xs text-primary hover:text-primary-hover">应用</button>
                        </div>

                        <div class="flex items-center gap-1 bg-black/20 p-1 rounded-lg">
                            <button v-for="f in ['all', 'completed', 'failed', 'pending']" :key="f"
                                @click="chapterFilter = f"
                                class="px-3 py-1 rounded text-[10px] font-medium transition-all uppercase tracking-wider"
                                :class="chapterFilter === f ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'">
                                {{ f === 'all' ? '全部' : (f === 'completed' ? '完成' : (f === 'failed' ? '失败' : '待办')) }}
                            </button>
                        </div>
                    </div>

                    <!-- Chapter List -->
                    <div class="space-y-2">
                        <div v-for="chapter in filteredChapters" :key="chapter.id"
                            class="group flex items-center p-3 rounded-xl border transition-all duration-200" :class="[
                                 selectedChapters.has(chapter.id) ? 'bg-primary/5 border-primary/20' : 'bg-bg-card border-white/5 hover:border-gray-700',
                                 chapter.status === 'processing' ? 'animate-pulse border-blue-500/30' : ''
                             ]" @click="toggleChapter(chapter.id)">

                            <!-- Checkbox -->
                            <div class="mr-4 flex-shrink-0">
                                <div class="w-5 h-5 rounded border flex items-center justify-center transition-colors"
                                    :class="selectedChapters.has(chapter.id) ? 'bg-primary border-primary' : 'border-gray-600 group-hover:border-gray-500'">
                                    <i v-if="selectedChapters.has(chapter.id)"
                                        class="ri-check-line text-white text-xs"></i>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-mono text-gray-500">#{{ chapter.id }}</span>
                                    <h4
                                        class="text-sm font-medium text-gray-200 truncate group-hover:text-white transition-colors">
                                        {{ chapter.title }}</h4>
                                </div>
                                <div class="flex items-center gap-3 text-[10px]">
                                    <!-- Status Badge -->
                                    <span class="px-1.5 py-0.5 rounded flex items-center gap-1" :class="{
                                              'bg-green-500/10 text-green-400': chapter.status === 'completed',
                                              'bg-red-500/10 text-red-400': chapter.status === 'failed',
                                              'bg-blue-500/10 text-blue-400': chapter.status === 'processing',
                                              'bg-gray-700/50 text-gray-500': !chapter.status || chapter.status === 'pending'
                                          }">
                                        <i :class="{
                                            'ri-check-line': chapter.status === 'completed',
                                            'ri-error-warning-line': chapter.status === 'failed',
                                            'ri-loader-4-line animate-spin': chapter.status === 'processing',
                                            'ri-time-line': !chapter.status || chapter.status === 'pending'
                                        }"></i>
                                        {{ chapter.status === 'completed' ? '已完成' : (chapter.status === 'failed' ? '失败'
                                        : (chapter.status === 'processing' ? '生成中' : '等待中')) }}
                                    </span>

                                    <span v-if="chapter.chars" class="text-gray-600">{{ chapter.chars }} 字</span>
                                </div>
                            </div>

                            <!-- Actions (Hover) -->
                            <div
                                class="ml-4 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click.stop="previewChapter(chapter)"
                                    class="p-1.5 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white"
                                    title="试听">
                                    <i class="ri-headphone-line"></i>
                                </button>
                                <button v-if="chapter.status === 'completed'" @click.stop="downloadZip(chapter.id)"
                                    class="p-1.5 rounded-lg hover:bg-white/10 text-gray-400 hover:text-primary"
                                    title="下载">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODAL_GROUP_INJECTION_POINT -->


                <div class="max-w-7xl mx-auto space-y-6">
                    <!-- Temporary Placeholder for development check -->
                    <div v-if="loading" class="flex items-center justify-center py-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Modals Group -->

        <!-- 1. Log Viewer Modal -->
        <div v-if="showLogs"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
            @click.self="showLogs = false">
            <div
                class="w-full max-w-5xl h-[85vh] bg-[#0c0c0c] border border-gray-800 rounded-xl shadow-2xl flex flex-col overflow-hidden font-mono text-sm">
                <!-- Log Header -->
                <div
                    class="flex items-center justify-between px-4 py-3 bg-[#111] border-b border-gray-800 text-gray-400">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 font-bold text-gray-200">
                            <i class="ri-terminal-box-fill text-primary"></i> System Logs
                            <span class="text-[10px] px-1.5 py-0.5 rounded border border-white/5"
                                :class="wsStatus === 'connected' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'">
                                {{ wsStatus === 'connected' ? 'LIVE' : 'OFFLINE' }}
                            </span>
                        </div>

                        <!-- Filters -->
                        <div class="flex bg-black/50 p-0.5 rounded-lg border border-white/5">
                            <button @click="logFilter = 'all'" class="px-3 py-1 text-xs rounded-md transition-all"
                                :class="logFilter === 'all' ? 'bg-gray-800 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'">
                                全部
                            </button>
                            <button @click="logFilter = 'packing'"
                                class="px-3 py-1 text-xs rounded-md transition-all flex items-center gap-1"
                                :class="logFilter === 'packing' ? 'bg-blue-500/20 text-blue-400 shadow-sm' : 'text-gray-500 hover:text-blue-400'">
                                <i class="ri-archive-line"></i> 打包
                            </button>
                            <button @click="logFilter = 'error'"
                                class="px-3 py-1 text-xs rounded-md transition-all flex items-center gap-1"
                                :class="logFilter === 'error' ? 'bg-red-500/20 text-red-400 shadow-sm' : 'text-gray-500 hover:text-red-400'">
                                <i class="ri-error-warning-line"></i> 错误
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div v-if="isScrollLocked"
                            class="text-xs text-yellow-500 flex items-center gap-1 animate-pulse">
                            <i class="ri-lock-2-line"></i> 滚动锁定中
                        </div>
                        <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-white"
                            :class="{'opacity-50': isScrollLocked}">
                            <input type="checkbox" v-model="autoScroll" :disabled="isScrollLocked"
                                class="accent-primary rounded bg-gray-800 border-gray-700"> 自动滚动
                        </label>
                        <div class="w-px h-4 bg-gray-800"></div>
                        <button @click="clearLogs" class="hover:text-red-400 transition-colors" title="清空日志"><i
                                class="ri-delete-bin-line"></i></button>
                        <button @click="showLogs = false" class="hover:text-white transition-colors"><i
                                class="ri-close-line text-lg"></i></button>
                    </div>
                </div>

                <!-- Log Body -->
                <div class="flex-1 overflow-y-auto p-4 space-y-0.5 bg-black text-gray-300 scrollbar-thin scrollbar-thumb-gray-800"
                    ref="logContainer" @scroll="onLogScroll">
                    <div v-if="filteredLogs.length === 0"
                        class="h-full flex flex-col items-center justify-center text-gray-700 opacity-50">
                        <i class="ri-command-line text-4xl mb-2"></i>
                        <p>Waiting for output...</p>
                    </div>
                    <div v-for="(log, i) in filteredLogs" :key="i"
                        class="flex gap-3 hover:bg-white/5 px-2 py-0.5 -mx-2 rounded group transition-colors">
                        <span class="text-gray-600 w-[70px] flex-shrink-0 select-none text-[10px] pt-0.5 font-mono">{{
                            formatLogTime(log.timestamp) }}</span>
                        <span class="break-words whitespace-pre-wrap font-mono text-xs leading-5 flex-1"
                            :class="getLogClass(log)">
                            <i v-if="log.level === 'success'" class="ri-check-line mr-1"></i>
                            <i v-if="log.level === 'error'" class="ri-close-circle-line mr-1"></i>
                            <i v-if="log.level === 'warning'" class="ri-alert-line mr-1"></i>
                            {{ log.message || log }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. File Manager Modal -->
        <div v-if="showFileManager"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
            @click.self="showFileManager = false">
            <div
                class="w-full max-w-4xl max-h-[80vh] bg-bg-card border border-border rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="p-5 border-b border-border flex justify-between items-center bg-bg-elevated/50">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="ri-folder-open-line text-primary"></i> 文件管理
                    </h3>

                    <!-- Storage Bar -->
                    <div
                        class="hidden sm:flex items-center gap-3 px-3 py-1.5 bg-black/20 rounded-lg border border-white/5">
                        <i class="ri-hard-drive-2-line text-gray-500"></i>
                        <div class="flex flex-col gap-0.5 w-32">
                            <div class="flex justify-between text-[10px] text-gray-400">
                                <span>存储空间</span>
                                <span :class="storageInfo.percent > 90 ? 'text-red-400' : 'text-primary'">{{
                                    storageInfo.percent }}%</span>
                            </div>
                            <div class="h-1.5 w-full bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500"
                                    :class="storageInfo.percent > 90 ? 'bg-red-500' : 'bg-primary'"
                                    :style="{ width: storageInfo.percent + '%' }"></div>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500 font-mono text-right min-w-[60px]">
                            {{ formatFileSize(storageInfo.used) }} / {{ formatFileSize(storageInfo.total) }}
                        </div>
                    </div>

                    <!-- Tabs and Selector -->
                    <div class="flex items-center gap-4 bg-black/20 p-1 rounded-lg">
                        <button @click="fileManagerTab = 'books'"
                            class="px-3 py-1 rounded text-sm font-medium transition-all"
                            :class="fileManagerTab === 'books' ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'">
                            书籍文件
                        </button>
                        <button @click="fileManagerTab = 'exports'"
                            class="px-3 py-1 rounded text-sm font-medium transition-all"
                            :class="fileManagerTab === 'exports' ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'">
                            导出归档
                        </button>
                    </div>

                    <button @click="showFileManager = false"
                        class="text-gray-400 hover:text-white transition-colors bg-white/5 p-1 rounded-lg hover:bg-white/10">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <div class="p-4 border-b border-border bg-bg-card/50 flex flex-wrap gap-4 items-center justify-between">
                    <!-- Left Actions (Filter/Select) -->
                    <div class="flex items-center gap-2 flex-1">
                        <!-- Book Selector (Only visible in 'books' tab) -->
                        <!-- Book Selector (Only visible in 'books' tab) -->
                        <div class="flex items-center gap-2" v-if="fileManagerTab === 'books'">
                            <select v-model="currentFileManagerBook"
                                class="bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:border-primary/50 outline-none max-w-[150px] sm:max-w-none">
                                <option value="" disabled>请选择书籍</option>
                                <option v-for="b in availableBooks" :key="b.id" :value="b.name">{{ b.title || b.name }}
                                    ({{ b.file_count }})</option>
                            </select>

                            <!-- Reverse Binding: Jump to Book -->
                            <button v-if="currentFileManagerBook" @click="jumpToBook(currentFileManagerBook)"
                                class="p-1.5 rounded-lg bg-white/5 hover:bg-primary hover:text-white text-gray-400 transition-colors"
                                title="跳转到书籍详情">
                                <i class="ri-share-forward-box-line"></i>
                            </button>
                        </div>

                        <button @click="toggleSelectAllFiles"
                            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1"
                            :class="isAllFilesSelected ? 'bg-primary/20 text-primary' : 'bg-white/5 text-gray-400 hover:text-white'">
                            <i :class="isAllFilesSelected ? 'ri-checkbox-circle-fill' : 'ri-checkbox-circle-line'"></i>
                            全选
                        </button>
                        <input v-if="fileManagerTab === 'books'" v-model="fileRangeInput" placeholder="ID 范围 (如 1-5)"
                            class="bg-black/20 border border-white/10 rounded px-2.5 py-1.5 text-xs text-gray-300 w-32 focus:border-primary/50 outline-none">
                    </div>

                    <!-- Right Actions (Batch Ops) -->
                    <div class="flex items-center gap-2">
                        <button v-if="fileManagerTab === 'books'" @click="downloadSelectedZip"
                            :disabled="selectedFiles.size === 0"
                            class="px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600 hover:text-white border border-green-600/20 rounded-lg text-xs flex items-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ri-download-cloud-2-line"></i> 下载选中
                        </button>
                        <button v-if="fileManagerTab === 'books'" @click="packBook"
                            :disabled="processingBooks.has(currentFileManagerBook || currentBook?.name) || !currentFileManagerBook"
                            class="px-3 py-1.5 bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white border border-blue-600/20 rounded-lg text-xs flex items-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ri-file-zip-line"
                                :class="processingBooks.has(currentFileManagerBook || currentBook?.name) ? 'animate-spin' : ''"></i>
                            打包
                        </button>
                        <!-- Export tab specific actions could go here -->
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2 bg-bg-card">
                    <div v-if="displayedFiles.length === 0" class="text-center py-20 text-gray-500">
                        <i class="ri-folder-add-line text-4xl mb-2"></i>
                        <p v-if="fileManagerTab === 'books' && !currentFileManagerBook">请选择一本书籍</p>
                        <p v-else>暂无文件</p>
                    </div>

                    <table v-else class="w-full text-left border-collapse text-sm">
                        <thead class="text-xs text-gray-500 uppercase bg-white/5 sticky top-0 z-10 backdrop-blur-md">
                            <tr>
                                <th class="p-3 rounded-tl-lg w-10">选择</th>
                                <th class="p-3">名称</th>
                                <th class="p-3">大小</th>
                                <th class="p-3">时间</th>
                                <th class="p-3 rounded-tr-lg text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <tr v-for="file in displayedFiles" :key="file.id || file.path"
                                class="hover:bg-white/5 transition-colors group"
                                :class="selectedFiles.has(file.id || file.path) ? 'bg-primary/5' : ''">
                                <td class="p-3">
                                    <div class="w-4 h-4 rounded border flex items-center justify-center cursor-pointer transition-colors"
                                        :class="selectedFiles.has(file.id || file.path) ? 'bg-primary border-primary' : 'border-gray-600 hover:border-gray-400'"
                                        @click="toggleFileSelection(file.id || file.path)">
                                        <i v-if="selectedFiles.has(file.id || file.path)"
                                            class="ri-check-line text-white text-xs"></i>
                                    </div>
                                </td>
                                <td class="p-3 text-gray-300 font-medium">
                                    <div class="flex items-center gap-2">
                                        <i
                                            :class="file.type === 'zip' ? 'ri-file-zip-line text-yellow-500' : 'ri-music-fill text-blue-500'"></i>
                                        {{ file.filename || file.name }}
                                    </div>
                                </td>
                                <td class="p-3 text-gray-500 text-xs font-mono">{{ formatFileSize(file.size) }}</td>
                                <td class="p-3 text-gray-500 text-xs font-mono">
                                    {{ file.created_at ? new Date(file.created_at * 1000).toLocaleString() : '-' }}
                                </td>
                                <td class="p-3 text-right flex justify-end gap-2">
                                    <!-- Listen/Download buttons based on type -->
                                    <button v-if="fileManagerTab === 'books'"
                                        @click="downloadFile(currentFileManagerBook, file.id)"
                                        class="p-1 text-gray-400 hover:text-primary transition-colors" title="下载">
                                        <i class="ri-download-line"></i>
                                    </button>
                                    <button v-if="fileManagerTab === 'exports'" @click="downloadExport(file.path)"
                                        class="p-1 text-gray-400 hover:text-green-500 transition-colors" title="下载ZIP">
                                        <i class="ri-download-cloud-2-line"></i>
                                    </button>

                                    <!-- Delete Button -->
                                    <button
                                        @click="deleteFileItem(fileManagerTab === 'exports' ? 'export_file' : 'book_file', fileManagerTab === 'exports' ? file.path : `${currentFileManagerBook}/${file.filename}`)"
                                        :disabled="fileManagerTab === 'books' && processingBooks.has(currentFileManagerBook)"
                                        class="p-1 text-gray-400 hover:text-red-500 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                                        :title="fileManagerTab === 'books' && processingBooks.has(currentFileManagerBook) ? '打包中，禁止删除' : '删除'">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. Global Settings Modal -->
        <div v-if="showSettings"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
            @click.self="showSettings = false">
            <div class="w-full max-w-2xl bg-bg-card border border-border rounded-2xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2"><i
                            class="ri-settings-4-line text-accent"></i> 全局设置</h2>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-white"><i
                            class="ri-close-line text-xl"></i></button>
                </div>

                <div class="space-y-6">
                    <!-- Advanced TTS -->
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">高级 TTS 参数</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs text-gray-400">并发限制</label>
                                <input v-model.number="concurrency" type="number" min="1" max="10"
                                    class="w-full bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-400">最大重试次数</label>
                                <input v-model.number="maxRetries" type="number"
                                    class="w-full bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-400">超时时间 (秒)</label>
                                <input v-model.number="timeout" type="number"
                                    class="w-full bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-400">单次最大字符数</label>
                                <input v-model.number="maxChars" type="number"
                                    class="w-full bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Bark Notification -->
                    <div class="space-y-4 pt-4 border-t border-white/5">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Bark 手机通知</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="barkConfig.enabled" class="sr-only peer">
                                <div
                                    class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                        </div>
                        <div v-if="barkConfig.enabled" class="grid grid-cols-1 gap-4 animate-fade-in-down">
                            <input v-model="barkConfig.serverUrl" placeholder="服务器地址 (可选)"
                                class="w-full bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                            <div class="flex gap-2">
                                <input v-model="barkConfig.apiKey" placeholder="Bark Key (必填)"
                                    class="flex-1 bg-black/20 border border-border rounded p-2 text-sm text-white focus:border-primary/50 outline-none">
                                <button @click="testBarkNotification" :disabled="barkTesting"
                                    class="px-3 py-1 bg-white/10 hover:bg-white/20 text-gray-300 rounded text-xs">
                                    {{ barkTesting ? '...' : '测试' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-white/5 flex items-center justify-end gap-3">
                    <button @click="resetConfig"
                        class="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">重置</button>
                    <button @click="saveAsDefault"
                        class="px-5 py-2 bg-primary hover:bg-primary-hover text-white rounded-lg text-sm font-medium shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                        <i class="ri-save-3-line" v-if="!saving"></i>
                        <i class="ri-loader-4-line animate-spin" v-else></i>
                        {{ saving ? '保存中...' : '保存配置' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Update Modal -->
        <div v-if="showUpdateModal"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
            <div
                class="w-full max-w-md bg-bg-card border border-primary/30 rounded-2xl shadow-2xl relative overflow-hidden">
                <div
                    class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-accent animate-gradient-x">
                </div>
                <div class="p-6 text-center">
                    <div
                        class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4 animate-bounce">
                        <i class="ri-rocket-2-fill text-3xl text-primary"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">发现新版本</h3>
                    <p class="text-gray-400 text-sm mb-6">{{ updateInfo?.message || 'NovelVoice有重要的功能更新。' }}</p>

                    <div class="flex gap-3 justify-center">
                        <button @click.stop="handleDismissUpdate"
                            class="px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 text-sm transition-colors">暂不更新</button>
                        <a href="https://github.com/skyshenma/NovelVoice/releases" target="_blank"
                            class="px-5 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white text-sm font-bold shadow-lg shadow-primary/20 transition-all">
                            前往更新
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toasts -->
        <div class="fixed top-4 right-4 z-[70] flex flex-col gap-2 pointer-events-none">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id"
                    class="pointer-events-auto min-w-[300px] max-w-sm bg-bg-elevated/90 backdrop-blur-md border border-white/10 rounded-xl p-4 shadow-2xl flex items-start gap-3 transform transition-all duration-300"
                    :class="toast.type === 'error' ? 'border-l-4 border-l-red-500' : (toast.type === 'success' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-blue-500')">
                    <i class="mt-0.5 text-lg" :class="{
                           'ri-checkbox-circle-fill text-green-500': toast.type === 'success',
                           'ri-error-warning-fill text-red-500': toast.type === 'error',
                           'ri-information-fill text-blue-500': toast.type === 'info' || toast.type === 'warning'
                       }"></i>
                    <div class="flex-1 text-sm text-gray-200 leading-snug break-words">
                        {{ toast.message }}
                    </div>
                </div>
            </transition-group>
        </div>




        <!-- Context Menu -->
        <div v-if="contextMenu.show"
            class="fixed z-50 bg-bg-elevated border border-border rounded-lg shadow-xl py-1 w-48 animate-fade-in"
            :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" @click.stop>
            <div class="px-3 py-2 border-b border-white/5 mb-1">
                <div class="text-xs text-gray-500 font-bold truncate">{{ contextMenu.book?.name }}</div>
            </div>
            <button @click="openBookFolder(contextMenu.book.name); contextMenu.show = false"
                class="w-full text-left px-4 py-2 hover:bg-white/5 text-gray-300 hover:text-white text-sm flex items-center gap-2">
                <i class="ri-folder-2-line"></i> 打开文件夹
            </button>
            <button @click="openFileManager(contextMenu.book.name); contextMenu.show = false"
                class="w-full text-left px-4 py-2 hover:bg-white/5 text-gray-300 hover:text-white text-sm flex items-center gap-2">
                <i class="ri-file-list-line"></i> 管理文件
            </button>
            <button @click="packBookFromMenu(contextMenu.book); contextMenu.show = false"
                class="w-full text-left px-4 py-2 hover:bg-white/5 text-gray-300 hover:text-white text-sm flex items-center gap-2">
                <i class="ri-file-zip-line"></i> 打包下载
            </button>
            <div class="h-px bg-white/5 my-1"></div>
            <button @click="deleteBook(contextMenu.book.name); contextMenu.show = false"
                class="w-full text-left px-4 py-2 hover:bg-red-500/10 text-red-400 hover:text-red-300 text-sm flex items-center gap-2">
                <i class="ri-delete-bin-line"></i> 删除书籍
            </button>
        </div>

        <!-- Backdrop for Context Menu -->
        <div v-if="contextMenu.show" @click="contextMenu.show = false" class="fixed inset-0 z-40"></div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, onBeforeUnmount, nextTick } = Vue;

        createApp({
            setup() {
                // --- UI State ---
                const viewMode = ref('list');
                const showMobileSidebar = ref(false);
                const showLogs = ref(false);
                const showSettings = ref(false);
                const loading = ref(false);
                const contextMenu = ref({ show: false, x: 0, y: 0, book: null });

                // --- Original Data & State ---
                const currentBook = ref(null);
                const books = ref([]);
                const chapters = ref([]);
                const selectedChapters = ref(new Set());
                const voices = ref([]);

                const currentTaskStatus = ref({ is_running: false, is_paused: false, current_chapter: [] });
                const currentChapterIds = computed(() => currentTaskStatus.value.current_chapter || []);

                const uploading = ref(false);
                const fileInput = ref(null);

                // Config
                const rateVal = ref(0);
                const volumeVal = ref(0);
                const pitchVal = ref(0);
                const concurrency = ref(2);
                const config = ref({
                    voice: "zh-CN-XiaoxiaoNeural",
                    rate: "+0%",
                    volume: "+0%",
                    pitch: "+0Hz"
                });

                // Bark
                const barkConfig = ref({ serverUrl: "", apiKey: "", enabled: false });
                const barkTesting = ref(false);

                // Advanced Settings
                const maxRetries = ref(3);
                const timeout = ref(30);
                const maxChars = ref(8000);
                const saving = ref(false);
                const reloadingConfig = ref(false);

                // Version & Upgrade
                const updateInfo = ref(null);
                const showUpdateModal = ref(false);
                const versionInfo = ref({ app_version: '...', engine_version: '...' });
                const checkingVersion = ref(false);

                // File Manager
                const showFileManager = ref(false);
                const audioFiles = ref([]);
                const selectedFiles = ref(new Set());
                const fileRangeInput = ref('');

                // Logs
                // Logs
                const logs = ref([]);
                const logFilter = ref('all'); // all, packing, error
                const isScrollLocked = ref(false);

                const filteredLogs = computed(() => {
                    if (logFilter.value === 'all') return logs.value;
                    if (logFilter.value === 'packing') return logs.value.filter(l => l && l.message && l.message.includes('打包'));
                    if (logFilter.value === 'error') return logs.value.filter(l => l && (l.level === 'error' || l.level === 'warning'));
                    return logs.value;
                });
                const wsStatus = ref('disconnected');
                const autoScroll = ref(true);
                const logContainer = ref(null);
                const toasts = ref([]);
                let toastId = 0;

                // Packing
                const packingProgress = ref({});
                const processingBooks = ref(new Set());

                // API
                const api = axios.create({ baseURL: '/api' });
                let ws = null;
                let reconnectTimer = null;
                const isConnected = ref(false);

                // --- Methods ---

                const showToast = (message, type = 'info', duration = 3000) => {
                    const id = toastId++;
                    toasts.value.push({ id, message, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), duration);
                };

                // Context Menu
                const openProductContextMenu = (book, event) => {
                    contextMenu.value = {
                        show: true,
                        x: Math.min(event.clientX, window.innerWidth - 200), // Prevent overflow
                        y: Math.min(event.clientY, window.innerHeight - 200),
                        book: book
                    };
                };

                const packBookFromMenu = async (book) => {
                    // Verify book is valid
                    currentBook.value = book;
                    await packBook();
                };

                // Data Fetching
                const fetchBooks = async () => {
                    try {
                        const res = await api.get('/books');
                        books.value = res.data;
                        if (currentBook.value) {
                            const updated = books.value.find(b => b.name === currentBook.value.name);
                            if (updated) currentBook.value = updated;
                        }
                    } catch (e) { console.error(e); }
                };

                const enterDetail = async (book) => {
                    loading.value = true;
                    currentBook.value = book;
                    viewMode.value = 'detail';
                    selectedChapters.value.clear();
                    try {
                        await Promise.all([fetchChapters(), fetchTaskStatus()]);
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchChapters = async () => {
                    if (!currentBook.value) return;
                    try {
                        const res = await api.get(`/chapters/${encodeURIComponent(currentBook.value.name)}`);
                        chapters.value = res.data;
                    } catch (e) { showToast("获取章节失败", "error"); }
                };

                const fetchTaskStatus = async () => {
                    if (!currentBook.value) return;
                    try {
                        const res = await api.get(`/status/${encodeURIComponent(currentBook.value.name)}`);
                        currentTaskStatus.value = res.data;
                    } catch (e) { }
                };

                // Selection & filters
                const chapterFilter = ref('all');
                const filteredChapters = computed(() => {
                    if (chapterFilter.value === 'all') return chapters.value;
                    return chapters.value.filter(c => {
                        if (chapterFilter.value === 'completed') return c.status === 'completed';
                        if (chapterFilter.value === 'failed') return c.status === 'failed';
                        return !c.status || c.status === 'pending';
                    });
                });

                const isAllSelected = computed(() => filteredChapters.value.length > 0 && filteredChapters.value.every(c => selectedChapters.value.has(c.id)));

                const toggleChapter = (id) => {
                    if (selectedChapters.value.has(id)) selectedChapters.value.delete(id);
                    else selectedChapters.value.add(id);
                };

                const toggleSelectAll = () => {
                    if (isAllSelected.value) filteredChapters.value.forEach(c => selectedChapters.value.delete(c.id));
                    else filteredChapters.value.forEach(c => selectedChapters.value.add(c.id));
                };

                const rangeInput = ref("");
                const parseRangeInput = (input) => {
                    const parts = input.split(/[,，]/);
                    const ids = [];
                    parts.forEach(part => {
                        part = part.trim();
                        if (!part) return;
                        if (part.includes('-')) {
                            const [start, end] = part.split('-').map(s => parseInt(s.trim()));
                            if (!isNaN(start) && !isNaN(end)) for (let i = start; i <= end; i++) ids.push(i);
                        } else {
                            const id = parseInt(part);
                            if (!isNaN(id)) ids.push(id);
                        }
                    });
                    return ids;
                };

                const applyRangeSelection = () => {
                    const input = rangeInput.value.trim();
                    selectedChapters.value.clear();
                    if (!input) { toggleSelectAll(); return; }
                    const ids = parseRangeInput(input);
                    const allIds = new Set(chapters.value.map(c => c.id));
                    ids.forEach(id => { if (allIds.has(id)) selectedChapters.value.add(id); });
                    if (ids.length > 0) showToast(`已选中 ${ids.length} 个章节`);
                };

                // Actions
                const startSelected = async () => {
                    let idsToRun = Array.from(selectedChapters.value);
                    if (idsToRun.length === 0) {
                        if (confirm("未选中任何章节，是否默认生成全部章节？")) {
                            idsToRun = chapters.value.map(c => c.id);
                            chapters.value.forEach(c => selectedChapters.value.add(c.id));
                        } else return;
                    }
                    const payload = {
                        book_name: currentBook.value.name,
                        chapter_ids: idsToRun,
                        config: {
                            voice: config.value.voice,
                            rate: config.value.rate,
                            volume: config.value.volume,
                            pitch: config.value.pitch || "+0Hz"
                        }
                    };
                    try {
                        await api.post('/start', payload);
                        fetchTaskStatus();
                        showToast("任务已启动", "success");
                    } catch (e) { showToast("启动失败: " + e.message, "error"); }
                };

                const pauseTask = async () => {
                    await api.post(`/pause/${encodeURIComponent(currentBook.value.name)}`);
                    fetchTaskStatus();
                    showToast("任务已暂停");
                };

                const resumeTask = async () => {
                    await api.post(`/resume/${encodeURIComponent(currentBook.value.name)}`);
                    fetchTaskStatus();
                    showToast("任务已继续");
                };

                const deleteBook = async (bookName) => {
                    if (books.value.find(b => b.name === bookName)?.zip_status === 'packing') {
                        showToast('打包任务进行中，无法删除书籍', 'warning');
                        return;
                    }
                    if (!confirm(`确定要删除书籍 "${bookName}" 吗？\n这将删除所有音频文件和配置。`)) return;
                    try {
                        await api.delete(`/api/books/${encodeURIComponent(bookName)}`);
                        showToast(`书籍 "${bookName}" 已删除`);
                        if (currentBook.value?.name === bookName) {
                            currentBook.value = null;
                            viewMode.value = 'list';
                        }
                        await fetchBooks();
                    } catch (e) { showToast("删除失败: " + e.message, "error"); }
                };

                // Upload
                const handleUpload = async (file) => {
                    if (!file) return;
                    uploading.value = true;
                    showToast("正在上传...", "info");
                    const formData = new FormData();
                    formData.append("file", file);
                    try {
                        await api.post('/upload', formData);
                        await fetchBooks();
                        showToast("上传成功", "success");
                    } catch (e) { showToast("上传失败: " + (e.response?.data?.detail || e.message), "error"); }
                    finally { uploading.value = false; }
                };
                const handleFileSelect = (e) => handleUpload(e.target.files[0]);
                const handleDrop = (e) => handleUpload(e.dataTransfer.files[0]);

                // Config & Preview
                const testVoice = async () => {
                    // ... (implement test voice logic same as before but use toast)
                    // Simplified for brevity, assume logic copied from backup
                    showToast("正在试听...", "info");
                    try {
                        const url = `/api/voice/preview/${config.value.voice}?rate=${encodeURIComponent(config.value.rate)}&volume=${encodeURIComponent(config.value.volume)}&pitch=${encodeURIComponent(config.value.pitch)}`;
                        const audio = new Audio(url);
                        await audio.play();
                    } catch (e) { showToast("试听失败", "error"); }
                };

                const previewing = ref(false); // needed for button state

                // Watchers for Config sliders to strings
                watch(rateVal, v => config.value.rate = (v >= 0 ? "+" : "") + v + "%");
                watch(volumeVal, v => config.value.volume = (v >= 0 ? "+" : "") + v + "%");
                watch(pitchVal, v => config.value.pitch = (v >= 0 ? "+" : "") + v + "Hz");

                const resetConfig = () => {
                    rateVal.value = 0; volumeVal.value = 0; pitchVal.value = 0; concurrency.value = 2;
                };

                const reloadConfig = async (silent = false) => {
                    // ... same logic as backup ...
                    reloadingConfig.value = true;
                    try {
                        const res = await api.post('/config/reload');
                        if (res.data.success) {
                            // Apply backend config to local state
                            const tts = res.data.config.tts;
                            if (tts) {
                                if (tts.default_voice) config.value.voice = tts.default_voice;
                                if (tts.default_rate) rateVal.value = parseInt(tts.default_rate.replace(/[%+]/g, ''));
                                if (tts.default_volume) volumeVal.value = parseInt(tts.default_volume.replace(/[%+]/g, ''));
                                if (tts.default_pitch) pitchVal.value = parseInt(tts.default_pitch.replace(/[Hz+]/g, ''));
                                if (tts.concurrency_limit) concurrency.value = tts.concurrency_limit;
                                if (tts.max_retries) maxRetries.value = tts.max_retries;
                            }
                            // Bark
                            if (res.data.config.bark) {
                                barkConfig.value = {
                                    enabled: res.data.config.bark.enabled,
                                    serverUrl: res.data.config.bark.server_url,
                                    apiKey: res.data.config.bark.api_key
                                };
                            }
                            // Voices
                            if (res.data.config.voices) {
                                voices.value = res.data.config.voices.map(v => ({
                                    ShortName: v.short_name,
                                    LocalName: v.local_name || v.short_name, // fallback
                                    Gender: v.gender_cn || v.gender
                                }));
                            }
                            if (!silent) showToast("配置已重新加载", "success");
                        }
                    } catch (e) { if (!silent) showToast("配置加载失败", "error"); }
                    finally { reloadingConfig.value = false; }
                };

                const saveAsDefault = async () => {
                    saving.value = true;
                    try {
                        const payload = {
                            tts: {
                                default_voice: config.value.voice,
                                default_rate: config.value.rate,
                                default_volume: config.value.volume,
                                default_pitch: config.value.pitch,
                                concurrency_limit: parseInt(concurrency.value),
                                max_retries: parseInt(maxRetries.value),
                                timeout: parseInt(timeout.value),
                                max_chars: parseInt(maxChars.value)
                            },
                            bark: {
                                enabled: barkConfig.value.enabled,
                                server_url: barkConfig.value.serverUrl,
                                api_key: barkConfig.value.apiKey
                            }
                        };
                        const res = await api.post('/config', payload);
                        if (res.data.success) {
                            await reloadConfig(true); // reload to confirm
                            showToast("配置保存成功", "success");
                        } else showToast("保存失败: " + res.data.message, "error");
                    } catch (e) { showToast("保存异常", "error"); }
                    finally { saving.value = false; }
                };

                // Log Logic
                // logs, logFilter, isScrollLocked declared above

                const connectWebSocket = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    ws = new WebSocket(`${protocol}//${window.location.host}/api/ws/logs`);
                    ws.onopen = () => { isConnected.value = true; wsStatus.value = 'connected'; };
                    ws.onmessage = (e) => {
                        const rawMsg = e.data;
                        if (rawMsg === '_PING_') return;

                        let logEntry = { message: rawMsg, level: 'info', timestamp: Date.now() / 1000 };

                        try {
                            const parsed = JSON.parse(rawMsg);
                            if (parsed && parsed.message) {
                                logEntry = parsed;
                            }
                        } catch (e) {
                            // Fallback for plain text legacy logs
                        }

                        logs.value.push(logEntry);
                        if (logs.value.length > 2000) logs.value.shift();

                        if (autoScroll.value && !isScrollLocked.value) {
                            nextTick(() => {
                                if (logContainer.value) logContainer.value.scrollTop = logContainer.value.scrollHeight;
                            });
                        }

                        // Parse status logic (adapt to object structure)
                        const msgContent = logEntry.message || "";
                        if (msgContent.includes("打包进度")) {
                            const match = msgContent.match(/'(.*?)' 打包进度:\s*(\d+)%/);
                            if (match) {
                                const bookName = match[1];
                                const percent = parseInt(match[2]);
                                packingProgress.value[bookName] = percent;
                                if (percent >= 100) {
                                    setTimeout(() => {
                                        delete packingProgress.value[bookName];
                                        processingBooks.value.delete(bookName);
                                        fetchBooks();
                                    }, 1000);
                                } else {
                                    processingBooks.value.add(bookName);
                                }
                            }
                        }
                        if (msgContent.includes("打包完成")) {
                            fetchBooks();
                            refreshFileManager();
                        }
                    };
                    ws.onclose = () => { isConnected.value = false; wsStatus.value = 'disconnected'; reconnectTimer = setTimeout(connectWebSocket, 3000); };
                };

                const onLogScroll = (e) => {
                    const el = e.target;
                    // Lock if scrolled up more than 50px from bottom
                    if (el.scrollHeight - el.scrollTop - el.clientHeight > 50) {
                        isScrollLocked.value = true;
                        autoScroll.value = false;
                    } else {
                        isScrollLocked.value = false;
                        autoScroll.value = true;
                    }
                };

                const clearLogs = () => logs.value = [];

                const getLogClass = (log) => {
                    const lvl = log.level || 'info';
                    if (lvl === 'error') return 'text-red-400';
                    if (lvl === 'warning') return 'text-yellow-400';
                    if (lvl === 'success') return 'text-green-400';
                    return 'text-gray-300'; // info
                };

                const formatLogTime = (ts) => {
                    if (!ts) return '';
                    const date = new Date(ts * 1000);
                    return date.toLocaleTimeString();
                };

                // File Manager Logic (Global)
                const fileManagerTab = ref('books'); // 'books' | 'exports'
                const fileManagerData = ref({ books: [], exports: [], total_size: 0 }); // Raw data from API
                const storageInfo = ref({ total: 0, used: 0, percent: 0, free: 0 }); // System Storage
                const currentFileManagerBook = ref(''); // Selected book in dropdown

                const availableBooks = computed(() => {
                    return (fileManagerData.value.books || []).filter(b => b.file_count > 0);
                });

                const jumpToBook = (bookName) => {
                    // Try to find full book object
                    const book = books.value.find(b => b.name === bookName) || { name: bookName, total: 0 };
                    enterDetail(book);
                    showFileManager.value = false;
                };

                const openFileManager = async (bookName = null) => {
                    showFileManager.value = true;
                    await refreshFileManager();

                    if (bookName) {
                        currentFileManagerBook.value = bookName;
                        fileManagerTab.value = 'books';
                    } else if (currentBook.value && !currentFileManagerBook.value) {
                        currentFileManagerBook.value = currentBook.value.name;
                    }
                };

                const refreshFileManager = async () => {
                    try {
                        const [resFiles, resStorage] = await Promise.all([
                            api.get('/files/summary'),
                            api.get('/system/storage')
                        ]);
                        fileManagerData.value = resFiles.data;
                        if (resStorage.data) storageInfo.value = resStorage.data;
                    } catch (e) { showToast("获取文件列表失败: " + (e.response?.data?.detail || e.message), "error"); }
                };

                // Computed: Flattened file list for display
                const displayedFiles = computed(() => {
                    if (fileManagerTab.value === 'exports') {
                        return fileManagerData.value.exports;
                    } else {
                        // Books tab: show files for selected book
                        if (!currentFileManagerBook.value) return [];
                        // We need to fetch files for specific book on demand or if API included them? 
                        // The /summary API only returns stats for books, not file lists to save bandwidth.
                        // So we still need specific book file fetching for "Books" tab details.
                        // Let's implement a hybrid approach:
                        // 1. 'Experts' tab uses summary data.
                        // 2. 'Books' tab uses /api/files/{bookName} like before, but managed here.
                        return audioFiles.value;
                    }
                });

                // Watcher for book selection in File Manager
                watch(currentFileManagerBook, async (newVal) => {
                    if (newVal && fileManagerTab.value === 'books') {
                        try {
                            const res = await api.get(`/files/${encodeURIComponent(newVal)}`);
                            audioFiles.value = res.data;
                            selectedFiles.value.clear();
                        } catch (e) { showToast("获取书籍文件失败", "error"); }
                    } else {
                        audioFiles.value = [];
                    }
                });

                // Watcher for Tab switching
                watch(fileManagerTab, async (newVal) => {
                    selectedFiles.value.clear();
                    if (newVal === 'books' && currentFileManagerBook.value) {
                        // re-fetch book files
                        const res = await api.get(`/files/${encodeURIComponent(currentFileManagerBook.value)}`);
                        audioFiles.value = res.data;
                    }
                });

                const deleteFileItem = async (type, path) => {
                    if (!confirm("确定要删除此文件吗？此操作不可恢复。")) return;
                    try {
                        // type: 'book_file' (path=Book/File) or 'export_file' (path=Filename)
                        await api.delete(`/files/delete?type=${type}&path=${encodeURIComponent(path)}`);
                        showToast("文件已删除");

                        // Refresh
                        if (type === 'export_file') await refreshFileManager();
                        else {
                            // Refresh current book files
                            const res = await api.get(`/files/${encodeURIComponent(currentFileManagerBook.value)}`);
                            audioFiles.value = res.data;
                        }
                    } catch (e) { showToast("删除失败: " + (e.response?.data?.detail || e.message), "error"); }
                };

                // ... (Existing helpers update) ...
                const toggleSelectAllFiles = () => {
                    const files = displayedFiles.value;
                    if (selectedFiles.value.size === files.length) selectedFiles.value.clear();
                    else files.forEach(f => selectedFiles.value.add(f.id || f.path)); // Use path for exports as ID
                };

                const isAllFilesSelected = computed(() => displayedFiles.value.length > 0 && selectedFiles.value.size === displayedFiles.value.length);

                const toggleFileSelection = (id) => {
                    if (selectedFiles.value.has(id)) selectedFiles.value.delete(id);
                    else selectedFiles.value.add(id);
                };

                // --- Restored & Updated Functions for Global File Manager ---

                const formatFileSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                };

                const downloadFile = (book, id) => window.open(`/api/file/${encodeURIComponent(book)}/${id}`, '_blank');

                // Lifecycle
                let pollTimer;
                onMounted(async () => {
                    await reloadConfig(true);
                    await fetchBooks();
                    await checkVersion();
                    connectWebSocket();
                    pollTimer = setInterval(() => {
                        if (viewMode.value === 'list') fetchBooks();
                        else { fetchChapters(); fetchTaskStatus(); }
                    }, 2000);
                });
                onBeforeUnmount(() => clearInterval(pollTimer));

                const downloadSelectedZip = async () => {
                    if (selectedFiles.value.size === 0) {
                        showToast("请先选择文件", "warning");
                        return;
                    }
                    if (confirm(`已选中 ${selectedFiles.value.size} 个文件。下载选中文件需要先进行打包。是否开始打包选中文件？`)) {
                        await packBook();
                    }
                };

                const packBook = async () => {
                    const bookName = currentFileManagerBook.value || currentBook.value?.name;
                    if (!bookName) return;

                    if (processingBooks.value.has(bookName)) return;

                    let description = "Full Pack";
                    if (fileRangeInput.value && fileRangeInput.value.trim()) description = `Range: ${fileRangeInput.value.trim()}`;
                    else if (selectedFiles.value.size > 0) description = `Custom Selection (${selectedFiles.value.size} files)`;

                    processingBooks.value.add(bookName);
                    try {
                        const selectedIds = Array.from(selectedFiles.value).join(',');
                        await api.post(`/pack/${encodeURIComponent(bookName)}?description=${encodeURIComponent(description)}&file_ids=${encodeURIComponent(selectedIds)}`);
                        showToast('打包任务已提交，请留意通知', 'success');
                        await fetchBooks();
                    } catch (e) {
                        showToast('启动打包失败: ' + (e.response?.data?.detail || e.message), 'error');
                    } finally {
                        setTimeout(() => processingBooks.value.delete(bookName), 1000);
                    }
                };

                const downloadZip = (assetId) => {
                    const bookName = currentFileManagerBook.value || currentBook.value?.name;
                    if (!bookName) return;

                    const url = assetId
                        ? `/api/assets/download/${assetId}`
                        : `/api/download_zip/${encodeURIComponent(bookName)}`;
                    window.open(url, '_blank');
                };

                const downloadExport = (filename) => {
                    window.open(`/api/files/download/export?filename=${encodeURIComponent(filename)}`, '_blank');
                };

                const previewChapter = async (chapter) => {
                    if (previewing.value) return;
                    if (!currentBook.value) return;

                    previewing.value = true;
                    showToast(`正在生成预览: ${chapter.title}`, 'info');
                    try {
                        const res = await api.post('/preview', {
                            book_name: currentBook.value.name,
                            chapter_id: chapter.id,
                            config: {
                                voice: config.value.voice,
                                rate: config.value.rate,
                                volume: config.value.volume,
                                pitch: config.value.pitch || "+0Hz"
                            }
                        }, { responseType: 'blob' });
                        const blob = new Blob([res.data], { type: 'audio/mpeg' });
                        const audio = new Audio(URL.createObjectURL(blob));
                        audio.onended = () => { previewing.value = false; };
                        audio.onerror = () => { previewing.value = false; showToast("播放出错", "error"); };
                        await audio.play();
                    } catch (e) {
                        showToast("预览失败: " + (e.response?.data?.detail || e.message), "error");
                        previewing.value = false;
                    }
                };

                const mergeAudio = async () => {
                    if (!currentBook.value) return;
                    const ids = selectedChapters.value.size > 0 ? Array.from(selectedChapters.value) : null;
                    if (!confirm(ids ? `确定合并选中的 ${ids.length} 个章节吗？` : "确定合并所有已完成的音频吗？")) return;

                    showToast("正在后台合并，请耐心等待...", "info");
                    try {
                        const res = await api.post(`/merge/${encodeURIComponent(currentBook.value.name)}`, {
                            book_name: currentBook.value.name,
                            chapter_ids: ids,
                            config: config.value
                        }, { responseType: 'blob' });

                        const url = window.URL.createObjectURL(new Blob([res.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', `${currentBook.value.name}_merged.mp3`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast("合并成功，开始下载", "success");
                    } catch (e) {
                        showToast("合并失败: " + (e.response?.data?.detail || e.message), "error");
                    }
                };

                const testBarkNotification = async () => {
                    if (!barkConfig.value.serverUrl || !barkConfig.value.apiKey) {
                        showToast("请先填写 Bark 配置", "warning");
                        return;
                    }
                    barkTesting.value = true;
                    try {
                        const res = await api.post('/bark/test', {
                            server_url: barkConfig.value.serverUrl,
                            api_key: barkConfig.value.apiKey
                        });
                        if (res.data.success) showToast("测试成功", "success");
                        else showToast("测试失败: " + res.data.message, "error");
                    } catch (e) { showToast("测试异常", "error"); }
                    finally { barkTesting.value = false; }
                };

                const checkVersion = async () => {
                    checkingVersion.value = true;
                    try {
                        const res = await api.get('/version/info');
                        versionInfo.value = res.data;
                        if (res.data.app_update_available) showUpdateModal.value = true;
                    } catch (e) { } finally { checkingVersion.value = false; }
                };
                const handleDismissUpdate = async () => {
                    showUpdateModal.value = false;
                    try {
                        await api.post('/version/dismiss');
                    } catch (e) { console.error("Dismiss update failed", e); }
                };
                const progressPercent = (book) => book.total ? Math.round((book.completed / book.total) * 100) : 0;
                const openBookFolder = (name) => api.post(`/open_folder?book_name=${encodeURIComponent(name)}`);

                return {
                    // UI State
                    viewMode, showMobileSidebar, showLogs, showSettings, loading,
                    contextMenu, updateInfo, showUpdateModal, versionInfo, checkingVersion,

                    // Data
                    currentBook, books, chapters, selectedChapters, voices,
                    currentTaskStatus, currentChapterIds, uploading, fileInput,

                    // Config
                    config, concurrency, rateVal, volumeVal, pitchVal, maxRetries, timeout, maxChars,
                    barkConfig, barkTesting, saving,

                    // File Manager
                    fileManagerTab, fileManagerData, storageInfo, currentFileManagerBook, displayedFiles,
                    showFileManager, openFileManager, refreshFileManager, deleteFileItem, availableBooks, jumpToBook,
                    audioFiles, selectedFiles, fileRangeInput, isAllFilesSelected,
                    toggleSelectAllFiles, toggleFileSelection, formatFileSize, downloadFile,
                    downloadSelectedZip, packBook, downloadZip, downloadExport,
                    openBookFolder,

                    // Logs
                    logs, wsStatus, autoScroll, logContainer, toasts,
                    processingBooks, packingProgress,
                    filteredLogs, logFilter, isScrollLocked, onLogScroll, formatLogTime,
                    clearLogs, getLogClass,

                    // Actions
                    fetchBooks, enterDetail, toggleChapter, toggleSelectAll, applyRangeSelection,
                    rangeInput, isAllSelected, chapterFilter, filteredChapters,
                    startSelected, pauseTask, resumeTask, deleteBook, handleUpload, handleFileSelect, handleDrop,
                    testVoice, previewing, resetConfig, saveAsDefault, previewChapter, mergeAudio, testBarkNotification,
                    checkVersion, handleDismissUpdate, dismissUpdate: handleDismissUpdate, progressPercent,

                    // Context Menu
                    openProductContextMenu, packBookFromMenu
                };
            }
        }).mount('#app');
    </script>
</body>

</html>