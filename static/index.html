<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelVoice - AI Audiobook Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden">
    <div id="app" class="flex h-full">
        <!-- Sidebar -->
        <div
            class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col p-6 space-y-6 overflow-y-auto shrink-0 z-20">
            <h1 class="text-2xl font-bold text-blue-400 flex items-center gap-2 cursor-pointer"
                @click="viewMode = 'list'">
                <span>ğŸ™ï¸</span> NovelVoice
            </h1>

            <!-- Project Info -->
            <div class="text-xs text-gray-400">
                <p class="mb-2 leading-relaxed">
                    NovelVoice æ˜¯ä¸€ä¸ªå¼€æºçš„ AI æœ‰å£°ä¹¦ç”Ÿæˆå™¨ï¼ŒåŸºäº Microsoft Edge TTS æŠ€æœ¯ã€‚
                </p>
                <a href="https://github.com/skyshenma/NovelVoice" target="_blank"
                    class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors inline-block">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                            clip-rule="evenodd" />
                    </svg>
                    GitHub é¡¹ç›®åœ°å€
                </a>
            </div>

            <!-- Upload (Moved to top) -->
            <div class="border-b border-gray-700 pb-6">
                <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">å¯¼å…¥ä¹¦ç±</h2>
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-750 transition-colors"
                    @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
                    <input type="file" ref="fileInput" class="hidden" accept=".txt,.epub" @change="handleFileSelect">
                    <p class="text-gray-400 text-sm" v-if="!uploading">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  TXT/EPUB</p>
                    <p class="text-blue-400 text-sm animate-pulse" v-else>æ­£åœ¨å¤„ç†...</p>
                </div>
            </div>

            <!-- Configuration -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">é…éŸ³è®¾ç½®</h2>
                    <div class="flex items-center gap-2">
                        <button @click="reloadConfig" :disabled="reloadingConfig"
                            class="text-xs flex items-center gap-1 transition-colors"
                            :class="reloadingConfig ? 'text-gray-600 cursor-not-allowed' : 'text-blue-500 hover:text-blue-400'"
                            title="ä»ç£ç›˜é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶">
                            <svg v-if="!reloadingConfig" class="w-4 h-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <svg v-else class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span>{{ reloadingConfig ? 'é‡è½½ä¸­' : 'é‡è½½é…ç½®' }}</span>
                        </button>
                        <button @click="resetConfig"
                            class="text-xs text-gray-500 hover:text-white flex items-center gap-1 transition-colors"
                            title="é‡ç½®å‚æ•°">
                            <span>â†º</span> é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- Voice -->
                <div>
                    <label class="block text-sm mb-1 text-gray-300">å‘éŸ³äºº (Voice)</label>
                    <select v-model="config.voice"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option v-for="v in voices" :key="v.ShortName" :value="v.ShortName">
                            {{ v.Description || `[${v.Style}] ${v.ShortName.split('-').pop().replace('Neural','')}
                            (${v.Gender})` }}
                        </option>
                    </select>
                </div>

                <!-- Rate -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label class="text-gray-300">è¯­é€Ÿ (Rate)</label>
                        <div class="flex items-center gap-1">
                            <input type="number" v-model="rateVal"
                                class="w-12 bg-transparent text-right outline-none text-blue-400 border-b border-gray-600 focus:border-blue-400 text-xs font-mono">
                            <span class="text-blue-400 text-xs">%</span>
                        </div>
                    </div>
                    <input type="range" min="-100" max="300" step="5" v-model="rateVal"
                        class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Volume -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label class="text-gray-300">éŸ³é‡ (Volume)</label>
                        <div class="flex items-center gap-1">
                            <input type="number" v-model="volumeVal"
                                class="w-12 bg-transparent text-right outline-none text-blue-400 border-b border-gray-600 focus:border-blue-400 text-xs font-mono">
                            <span class="text-blue-400 text-xs">%</span>
                        </div>
                    </div>
                    <input type="range" min="-100" max="100" step="5" v-model="volumeVal"
                        class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Pitch -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label class="text-gray-300">éŸ³è°ƒ (Pitch)</label>
                        <div class="flex items-center gap-1">
                            <input type="number" v-model="pitchVal"
                                class="w-12 bg-transparent text-right outline-none text-blue-400 border-b border-gray-600 focus:border-blue-400 text-xs font-mono">
                            <span class="text-blue-400 text-xs">Hz</span>
                        </div>
                    </div>
                    <input type="range" min="-50" max="50" step="1" v-model="pitchVal"
                        class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Concurrency -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label class="text-gray-300">å¹¶å‘æ•° (Threads)</label>
                        <span class="text-green-400">{{ concurrency }}</span>
                    </div>
                    <input type="number" min="1" max="10" v-model="concurrency" @change="updateConcurrency"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <!-- Advanced Settings (Moved to bottom) -->

                <!-- Save as Default Button -->
                <div class="pt-3 border-t border-gray-700">
                    <button @click="saveAsDefault" :disabled="saving"
                        class="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 disabled:text-gray-500 text-white text-sm py-2 rounded transition-colors flex items-center justify-center gap-2">
                        <span v-if="saving" class="animate-spin">â³</span>
                        <span v-else>ğŸ’¾</span>
                        {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¸ºé»˜è®¤é…ç½®' }}
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        ğŸ’¡ ä¿å­˜åä¸‹æ¬¡å¯åŠ¨å°†ä½¿ç”¨è¿™äº›é»˜è®¤å€¼
                    </p>
                </div>
            </div>

            <!-- Test Voice & Console -->
            <div class="space-y-4">
                <!-- Test Voice Button -->
                <button @click="testVoice" :disabled="previewing"
                    class="w-full bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 rounded flex items-center justify-center gap-2 transition-colors">
                    <span v-if="previewing" class="animate-spin">â³</span>
                    <span v-else>ğŸ”Š</span>
                    è¯•å¬å½“å‰å‘éŸ³äºº
                </button>

                <!-- Custom Preview Console -->
                <div class="pt-4 border-t border-gray-700">
                    <h2 class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">è‡ªå®šä¹‰è¯•å¬</h2>
                    <div class="relative">
                        <textarea v-model="customText" rows="3" maxlength="100"
                            class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs text-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none"
                            :placeholder="defaultCustomPlaceholder"></textarea>
                        <div class="absolute bottom-1 right-2 text-xs text-gray-500">{{ customText.length }}/100</div>
                    </div>

                    <div class="flex gap-2 mt-2">
                        <button @click="testCustomVoice" :disabled="customPreviewing || !customText"
                            class="flex-1 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 text-white text-xs py-1.5 rounded transition-colors flex items-center justify-center gap-1">
                            <span v-if="customPreviewing" class="animate-spin">â³</span>
                            <span v-else>ğŸ”Š</span>
                            è¯•å¬
                        </button>
                        <button @click="setRandomText" :disabled="customPreviewing"
                            class="px-3 bg-gray-600 hover:bg-gray-500 text-white text-xs py-1.5 rounded transition-colors"
                            title="éšæœºè¯­æ®µ">
                            âœ¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bark Notification Config -->
            <div class="pt-6 border-t border-gray-700 space-y-3">
                <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider flex items-center gap-2">
                    ğŸ“± æ¨é€é€šçŸ¥
                </h2>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Bark æœåŠ¡å™¨åœ°å€</label>
                    <input type="text" v-model="barkConfig.serverUrl" placeholder="https://api.day.app"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-xs text-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Bark Key</label>
                    <input type="password" v-model="barkConfig.apiKey" placeholder="ä½ çš„ Bark Key"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-xs text-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" v-model="barkConfig.enabled" id="barkEnabled"
                        class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <label for="barkEnabled" class="text-xs text-gray-300 cursor-pointer">å¯ç”¨æ¨é€é€šçŸ¥</label>
                </div>

                <button @click="testBarkNotification"
                    :disabled="barkTesting || !barkConfig.serverUrl || !barkConfig.apiKey"
                    class="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 disabled:text-gray-500 text-white text-xs py-2 rounded transition-colors flex items-center justify-center gap-2">
                    <span v-if="barkTesting" class="animate-spin">â³</span>
                    <span v-else>ğŸ””</span>
                    {{ barkTesting ? 'å‘é€ä¸­...' : 'å‘é€æµ‹è¯•é€šçŸ¥' }}
                </button>

                <p class="text-xs text-gray-500 leading-relaxed">
                    ğŸ’¡ æç¤ºï¼šå¯ç”¨åï¼Œä»»åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ä¼šè‡ªåŠ¨æ¨é€é€šçŸ¥åˆ°ä½ çš„æ‰‹æœº
                </p>
            </div>

            <!-- Advanced Settings (Bottom of sidebar) -->
            <div class="pt-6 border-t border-gray-700 pb-6">
                <button @click="showAdvanced = !showAdvanced"
                    class="w-full flex items-center justify-between text-sm text-gray-400 hover:text-white transition-colors">
                    <span class="flex items-center gap-2">
                        <span>âš™ï¸</span>
                        <span>é«˜çº§è®¾ç½®</span>
                    </span>
                    <span class="text-xs">{{ showAdvanced ? 'â–¼' : 'â–¶' }}</span>
                </button>

                <!-- Advanced Settings Panel -->
                <div v-show="showAdvanced" class="mt-3 space-y-3 animate-fade-in">
                    <!-- Max Retries -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">
                            é‡è¯•æ¬¡æ•° (0-10)
                        </label>
                        <input type="number" v-model="maxRetries" min="0" max="10"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <!-- Timeout -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">
                            è¶…æ—¶æ—¶é—´ (10-120ç§’)
                        </label>
                        <input type="number" v-model="timeout" min="10" max="120"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <!-- Max Chars -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">
                            æœ€å¤§å­—ç¬¦æ•° (1000-20000)
                        </label>
                        <input type="number" v-model="maxChars" min="1000" max="20000" step="1000"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <!-- Upload (Moved from bottom) -->
        </div>



        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-900 relative">

            <!-- LIST VIEW -->
            <div v-if="viewMode === 'list'" class="flex-1 overflow-y-auto p-8">
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-100">ä¹¦ç±åˆ—è¡¨</h2>
                        <button @click="fetchBooks"
                            class="text-sm text-gray-400 hover:text-white flex items-center gap-1">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>

                    <div class="grid gap-4">
                        <div v-for="book in books" :key="book.name"
                            class="bg-gray-800 rounded-lg p-5 border border-gray-700 shadow-lg hover:border-gray-600 transition-all cursor-pointer group"
                            @click="enterDetail(book)">

                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3
                                        class="text-lg font-semibold text-white mb-1 group-hover:text-blue-400 transition-colors">
                                        {{ book.name }}</h3>
                                    <p class="text-xs text-gray-500 font-mono">{{ book.path }}</p>
                                </div>
                                <span :class="statusClass(book.status)"
                                    class="px-2 py-1 rounded text-xs font-bold uppercase tracking-wide">
                                    {{ book.status }}
                                </span>
                            </div>

                            <!-- Progress -->
                            <div class="mb-4">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>{{ book.completed }} / {{ book.total }} ç« èŠ‚</span>
                                    <span>{{ progressPercent(book) }}%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-500"
                                        :style="{ width: progressPercent(book) + '%' }"></div>
                                </div>
                            </div>

                            <!-- Quick Start -->
                            <div class="mt-3 pt-3 border-t border-gray-700 flex items-center gap-2" @click.stop>
                                <input type="text" v-model="quickRanges[book.name]" placeholder="èŒƒå›´ (å¦‚ 1-10)"
                                    class="bg-gray-700 text-xs text-gray-200 px-2 py-1.5 rounded flex-1 outline-none border border-gray-600 focus:border-blue-500 placeholder-gray-500 transition-colors">

                                <button @click="handleQuickStart(book)" :disabled="book.status === 'processing'"
                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white text-xs rounded transition-colors whitespace-nowrap">
                                    â–¶ï¸ å¼€å§‹
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <button class="mt-2 text-sm text-blue-400 hover:text-blue-300">
                                    è¿›å…¥è¯¦æƒ… & ç®¡ç† >
                                </button>
                            </div>
                        </div>

                        <div v-if="books.length === 0"
                            class="text-center py-12 text-gray-500 bg-gray-800/50 rounded-lg border border-dashed border-gray-700">
                            æš‚æ— ä¹¦ç±ï¼Œè¯·å…ˆä¸Šä¼ 
                        </div>
                    </div>
                </div>
            </div>

            <!-- DETAIL VIEW -->
            <div v-else class="flex-1 flex flex-col h-full">
                <!-- Header -->
                <div class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center gap-4">
                        <button @click="viewMode = 'list'"
                            class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-700">
                            â† è¿”å›
                        </button>
                        <div>
                            <h2 class="text-lg font-bold text-white">{{ currentBook.name }}</h2>
                            <div class="text-xs text-gray-400 flex flex-wrap gap-4 items-center mt-1">
                                <span>Total: {{ chapters.length }}</span>

                                <!-- Selected Progress -->
                                <div class="flex items-center gap-2" v-if="selectedChapters.size > 0">
                                    <span class="text-blue-400">Selected: {{ selectedChapters.size }}</span>
                                    <div class="w-16 bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                        <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-500"
                                            :style="{ width: selectedProgress + '%' }"></div>
                                    </div>
                                    <span class="text-blue-400">{{ selectedProgress }}%</span>
                                </div>
                                <span v-else>Selected: 0</span>

                                <span v-if="currentTaskStatus.is_running"
                                    class="text-green-400 flex items-center gap-1">
                                    <span class="animate-pulse">â—</span> Running
                                </span>
                                <span v-else-if="currentTaskStatus.is_paused"
                                    class="text-yellow-400 flex items-center gap-1">
                                    <span>â¸</span> Paused
                                </span>
                            </div>
                        </div>
                    </div>

                    <button @click="openFolder(currentBook.name)"
                        class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-xs rounded transition-colors text-white">
                        ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹
                    </button>
                </div>

                <!-- Sticky Control Bar -->
                <div
                    class="bg-gray-800/90 backdrop-blur border-b border-gray-700 p-3 flex items-center gap-4 justify-between sticky top-0 z-10">
                    <div class="flex items-center gap-2">
                        <label
                            class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white select-none">
                            <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll"
                                class="w-4 h-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700">
                            å…¨é€‰
                        </label>
                        <span class="h-4 w-px bg-gray-600 mx-2"></span>
                        <button @click="deleteSelected"
                            :disabled="selectedChapters.size === 0 || currentTaskStatus.is_running"
                            class="text-xs text-red-400 hover:text-red-300 disabled:text-gray-600 px-2 py-1 rounded hover:bg-gray-700/50 transition-colors">
                            ğŸ—‘ï¸ æ¸…ç†é€‰ä¸­
                        </button>

                        <!-- Range Selection -->
                        <div
                            class="flex items-center bg-gray-700/50 rounded overflow-hidden border border-gray-600 focus-within:ring-1 focus-within:ring-blue-500">
                            <input type="text" v-model="rangeInput" placeholder="1-5,8"
                                @keydown.enter="applyRangeSelection"
                                class="w-20 bg-transparent text-xs text-gray-200 px-2 py-1 outline-none placeholder-gray-500">
                            <button @click="applyRangeSelection"
                                class="bg-gray-700 hover:bg-gray-600 text-gray-400 hover:text-white px-2 py-1 text-xs border-l border-gray-600 transition-colors"
                                title="åº”ç”¨èŒƒå›´">
                                âœ“
                            </button>
                        </div>

                        <!-- Logs Toggle -->
                        <button @click="showLogs = !showLogs"
                            class="text-gray-400 hover:text-white p-2 rounded hover:bg-gray-700 transition-colors"
                            title="æŸ¥çœ‹æ—¥å¿—">
                            <span class="text-sm">ğŸ“œ</span>
                        </button>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- Start Button -->
                        <button @click="startSelected"
                            v-if="!currentTaskStatus.is_running && !currentTaskStatus.is_paused"
                            :disabled="selectedChapters.size === 0"
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white text-sm font-medium rounded shadow-lg transition-all flex items-center gap-2">
                            <span>â–¶ï¸</span> å¼€å§‹ç”Ÿæˆ ({{ selectedChapters.size }})
                        </button>

                        <!-- Pause/Resume Controls -->
                        <template v-else>
                            <button @click="pauseTask" v-if="!currentTaskStatus.is_paused"
                                class="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-sm font-medium rounded shadow-lg transition-all flex items-center gap-2">
                                <span>â¸</span> æš‚åœ
                            </button>
                            <button @click="resumeTask" v-else
                                class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white text-sm font-medium rounded shadow-lg transition-all flex items-center gap-2">
                                <span>â–¶ï¸</span> ç»§ç»­
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Chapter List -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-900">
                    <div class="space-y-1">
                        <div v-for="chapter in chapters" :key="chapter.id"
                            class="flex items-center gap-3 p-3 rounded hover:bg-gray-800 transition-colors border border-transparent hover:border-gray-700 group"
                            :class="{'bg-gray-800/50': selectedChapters.has(chapter.id)}">

                            <input type="checkbox" :checked="selectedChapters.has(chapter.id)"
                                @change="toggleChapter(chapter.id)"
                                class="w-4 h-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700 cursor-pointer">

                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 font-mono text-xs w-12 text-right">#{{ chapter.id
                                        }}</span>
                                    <span class="text-sm text-gray-200 truncate font-medium">{{ chapter.title }}</span>
                                </div>
                                <div class="flex items-center gap-2 ml-14 mt-1">
                                    <span class="text-xs text-gray-500">{{ chapter.length }} å­—</span>
                                    <button @click.stop="previewChapter(chapter)"
                                        class="text-xs text-blue-500 hover:text-blue-300 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                        title="è¯•å¬å‰20å­—">
                                        ğŸ”Š è¯•å¬
                                    </button>
                                </div>
                            </div>

                            <!-- Dynamic Status Icon -->
                            <div class="w-24 text-right flex justify-end">
                                <span v-if="chapter.status === 'completed'"
                                    class="text-green-500 flex items-center gap-1 text-xs">
                                    âœ… å·²å®Œæˆ
                                </span>
                                <span v-else-if="chapter.status === 'failed'"
                                    class="text-red-500 flex items-center gap-1 text-xs">
                                    âŒ å¤±è´¥
                                </span>
                                <span v-else-if="currentChapterIds.includes(chapter.title)"
                                    class="text-blue-400 flex items-center gap-1 text-xs animate-pulse">
                                    â³ ç”Ÿæˆä¸­...
                                </span>
                                <span v-else class="text-gray-600 text-xs">
                                    ç­‰å¾…ä¸­
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‰ˆæœ¬æ›´æ–°å¼¹çª— -->
            <div v-if="showUpdateModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                @click.self="showUpdateModal = false">
                <div
                    class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700 animate-fade-in">
                    <!-- æ ‡é¢˜ -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="text-2xl">ğŸ‰</span>
                            <span>å‘ç°æ–°ç‰ˆæœ¬</span>
                        </h3>
                        <button @click="showUpdateModal = false"
                            class="text-gray-400 hover:text-white transition-colors">
                            <span class="text-2xl">Ã—</span>
                        </button>
                    </div>

                    <!-- å†…å®¹ -->
                    <div v-if="updateInfo" class="space-y-4">
                        <div class="bg-gray-900 rounded p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">å½“å‰ç‰ˆæœ¬</span>
                                <span class="text-white font-mono">{{ updateInfo.current_version }}</span>
                            </div>
                            <div class="flex items-center justify-center my-2">
                                <span class="text-green-400 text-2xl">â†“</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 text-sm">æœ€æ–°ç‰ˆæœ¬</span>
                                <span class="text-green-400 font-mono font-bold">{{ updateInfo.latest_version }}</span>
                            </div>
                        </div>

                        <p class="text-gray-300 text-sm">
                            <span class="font-semibold">{{ updateInfo.package }}</span>
                            æœ‰æ–°ç‰ˆæœ¬å¯ç”¨,å»ºè®®æ›´æ–°ä»¥è·å¾—æœ€æ–°åŠŸèƒ½å’Œä¿®å¤ã€‚
                        </p>

                        <!-- æ›´æ–°å‘½ä»¤ -->
                        <div class="bg-gray-900 rounded p-3">
                            <p class="text-xs text-gray-400 mb-2">æ›´æ–°å‘½ä»¤:</p>
                            <code class="text-green-400 text-sm font-mono">
                        pip install --upgrade {{ updateInfo.package }}
                    </code>
                        </div>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="flex gap-3 mt-6">
                        <button @click="dismissUpdate"
                            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                            ç¨åæé†’
                        </button>
                        <a v-if="updateInfo" :href="`https://pypi.org/project/${updateInfo.package}/`" target="_blank"
                            class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded text-center transition-colors">
                            æŸ¥çœ‹è¯¦æƒ…
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, onBeforeUnmount } = Vue;

        createApp({
            setup() {
                // UI State
                const viewMode = ref('list'); // 'list' | 'detail'
                const currentBook = ref(null);

                // Data
                const books = ref([]);
                const chapters = ref([]);
                const selectedChapters = ref(new Set());
                const voices = ref([]);

                // Status
                const currentTaskStatus = ref({ is_running: false, is_paused: false, current_chapter: [] });
                const currentChapterIds = computed(() => currentTaskStatus.value.current_chapter || []);

                // Upload
                const uploading = ref(false);
                const fileInput = ref(null);

                // Config
                const rateVal = ref(0);
                const volumeVal = ref(0);
                const pitchVal = ref(0);
                const concurrency = ref(2);
                const config = ref({
                    voice: "zh-CN-XiaoxiaoNeural",
                    rate: "+0%",
                    volume: "+0%",
                    pitch: "+0Hz"
                });

                // Bark Notification Config
                const barkConfig = ref({
                    serverUrl: "",
                    apiKey: "",
                    enabled: false
                });
                const barkTesting = ref(false);

                // Advanced Settings
                const showAdvanced = ref(false);
                const maxRetries = ref(3);
                const timeout = ref(30);
                const maxChars = ref(8000);
                const saving = ref(false);

                // Config Reload
                const reloadingConfig = ref(false);
                const lastReloadTime = ref('');

                // Version Check
                const updateInfo = ref(null);
                const showUpdateModal = ref(false);

                // Computed
                watch(rateVal, (val) => config.value.rate = (val >= 0 ? "+" : "") + val + "%"); // Explicitly append % for display/logic if needed, though input handles number
                watch(volumeVal, (val) => config.value.volume = (val >= 0 ? "+" : "") + val + "%");
                watch(pitchVal, (val) => config.value.pitch = (val >= 0 ? "+" : "") + val + "Hz");

                const resetConfig = () => {
                    rateVal.value = 0;
                    volumeVal.value = 0;
                    pitchVal.value = 0;
                    concurrency.value = 2; // Optional: Reset concurrency too? Keep it separate maybe? Or include it? 
                    // Let's reset pitch/rate/volume only as they are the main "config" params
                };

                const reloadConfig = async (silent = false) => {
                    // Normalize silent param (click event passes object)
                    const isSilent = silent === true;

                    if (reloadingConfig.value) return;

                    reloadingConfig.value = true;

                    try {
                        const res = await api.post('/config/reload');

                        if (res.data.success) {
                            // æ›´æ–° TTS é…ç½®
                            if (res.data.config.tts) {
                                const tts = res.data.config.tts;

                                // æ›´æ–°è¯­éŸ³
                                if (tts.default_voice) {
                                    config.value.voice = tts.default_voice;
                                }

                                // æ›´æ–°è¯­é€Ÿ
                                if (tts.default_rate) {
                                    const rate = parseInt(tts.default_rate.replace('%', '').replace('+', ''));
                                    rateVal.value = rate;
                                }

                                // æ›´æ–°éŸ³é‡
                                if (tts.default_volume) {
                                    const volume = parseInt(tts.default_volume.replace('%', '').replace('+', ''));
                                    volumeVal.value = volume;
                                }

                                // æ›´æ–°éŸ³è°ƒ
                                if (tts.default_pitch) {
                                    const pitch = parseInt(tts.default_pitch.replace('Hz', '').replace('+', ''));
                                    pitchVal.value = pitch;
                                }

                                // æ›´æ–°å¹¶å‘æ•°
                                if (tts.concurrency_limit) {
                                    concurrency.value = tts.concurrency_limit;
                                }

                                // æ›´æ–°é«˜çº§è®¾ç½®
                                if (tts.max_retries !== undefined) {
                                    maxRetries.value = tts.max_retries;
                                }
                                if (tts.timeout !== undefined) {
                                    timeout.value = tts.timeout;
                                }
                                if (tts.max_chars !== undefined) {
                                    maxChars.value = tts.max_chars;
                                }
                            }

                            // æ›´æ–° Bark é…ç½®
                            if (res.data.config.bark) {
                                const bark = res.data.config.bark;
                                barkConfig.value.enabled = bark.enabled || false;
                                barkConfig.value.serverUrl = bark.server_url || '';
                                barkConfig.value.apiKey = bark.api_key || '';
                            }

                            // æ›´æ–°è¯­éŸ³åˆ—è¡¨
                            if (res.data.config.voices && res.data.config.voices.length > 0) {
                                voices.value = res.data.config.voices.map(v => ({
                                    ShortName: v.short_name,
                                    Gender: v.gender_cn || v.gender,
                                    Style: v.style,
                                    Description: v.description
                                }));
                            }

                            // æ›´æ–°æ—¶é—´æˆ³
                            lastReloadTime.value = new Date().toLocaleTimeString('zh-CN');

                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            if (!isSilent) {
                                alert('âœ… ' + (res.data.message || 'é…ç½®å·²ä»ç£ç›˜åŒæ­¥æˆåŠŸ'));
                            }

                            // å¦‚æœæœ‰å˜æ›´,åœ¨æ§åˆ¶å°æ˜¾ç¤º
                            if (res.data.changes && Object.keys(res.data.changes).length > 0) {
                                console.log('[NovelVoice] Config changes:', res.data.changes);
                            }
                        }
                    } catch (error) {
                        console.error('[NovelVoice] Config reload failed:', error);
                        const message = error.response?.data?.detail || 'é…ç½®é‡è½½å¤±è´¥';
                        if (!isSilent) {
                            alert('âŒ ' + message);
                        } else {
                            console.error('Initial config reload failed:', message);
                        }
                    } finally {
                        reloadingConfig.value = false;
                    }
                };

                const isAllSelected = computed(() => {
                    return chapters.value.length > 0 && selectedChapters.value.size === chapters.value.length;
                });

                const selectedProgress = computed(() => {
                    if (selectedChapters.value.size === 0) return 0;
                    const completed = chapters.value.filter(c => selectedChapters.value.has(c.id) && c.status === 'completed').length;
                    return Math.round((completed / selectedChapters.value.size) * 100);
                });

                // API
                const api = axios.create({ baseURL: '/api' });

                // --- Methods ---

                const fetchBooks = async () => {
                    try {
                        const res = await api.get('/books');
                        books.value = res.data;
                    } catch (e) { console.error(e); }
                };

                const fetchVoices = async () => {
                    const res = await api.get('/voices');
                    voices.value = res.data;
                };

                const updateConcurrency = async () => {
                    await api.post(`/concurrency?limit=${concurrency.value}`);
                };

                // Chapter Management
                const enterDetail = async (book) => {
                    currentBook.value = book;
                    viewMode.value = 'detail';
                    selectedChapters.value.clear(); // Clear selection on enter? Or keep? Let's clear for now.
                    await fetchChapters();
                    await fetchTaskStatus();
                };

                const fetchChapters = async () => {
                    if (!currentBook.value) return;
                    try {
                        const res = await api.get(`/chapters/${currentBook.value.name}`);
                        chapters.value = res.data;
                    } catch (e) { console.error(e); }
                };

                const fetchTaskStatus = async () => {
                    if (!currentBook.value) return;
                    try {
                        const res = await api.get(`/status/${currentBook.value.name}`);
                        currentTaskStatus.value = res.data;
                    } catch (e) { }
                };

                const toggleChapter = (id) => {
                    if (selectedChapters.value.has(id)) selectedChapters.value.delete(id);
                    else selectedChapters.value.add(id);
                };

                const toggleSelectAll = () => {
                    if (isAllSelected.value) {
                        selectedChapters.value.clear();
                    } else {
                        chapters.value.forEach(c => selectedChapters.value.add(c.id));
                    }
                };

                const rangeInput = ref("");
                const quickRanges = ref({});

                // Logs
                const showLogs = ref(false);
                const logs = ref([]);
                const logContainer = ref(null);

                // Auto-scroll logs
                watch(logs, async () => {
                    if (showLogs.value && logContainer.value) {
                        await Vue.nextTick();
                        logContainer.value.scrollTop = logContainer.value.scrollHeight;
                    }
                }, { deep: true });

                // Auto-fetch logs when opened
                watch(showLogs, (val) => {
                    if (val) fetchLogs();
                });

                const fetchLogs = async () => {
                    if (!currentBook.value || !showLogs.value) return;
                    try {
                        const res = await api.get(`/logs/${currentBook.value.name}`);
                        // Only update if length changed or we want to force refresh. 
                        // To avoid jitter, we could check last log timestamp, but this is simple.
                        // Actually, just replacing provides latest state.
                        if (JSON.stringify(res.data.logs) !== JSON.stringify(logs.value)) {
                            logs.value = res.data.logs;
                        }
                    } catch (e) { }
                };

                // Validating user input: "1-5, 8, 10-12" to chapter IDs
                const applyRangeSelection = () => {
                    const input = rangeInput.value.trim();
                    selectedChapters.value.clear();

                    if (!input) {
                        // Empty -> Select All
                        toggleSelectAll();
                        return;
                    }

                    const parts = input.split(/[,ï¼Œ]/); // Support en/cn comma
                    const allIds = new Set(chapters.value.map(c => c.id));

                    parts.forEach(part => {
                        part = part.trim();
                        if (!part) return;

                        if (part.includes('-')) {
                            const [start, end] = part.split('-').map(s => parseInt(s.trim()));
                            if (!isNaN(start) && !isNaN(end)) {
                                for (let i = start; i <= end; i++) {
                                    if (allIds.has(i)) selectedChapters.value.add(i);
                                }
                            }
                        } else {
                            const id = parseInt(part);
                            if (!isNaN(id) && allIds.has(id)) {
                                selectedChapters.value.add(id);
                            }
                        }
                    });
                };

                // Quick Start from List View
                const handleQuickStart = async (book) => {
                    const rangeStr = quickRanges.value[book.name] || "";
                    let idsToRun = [];

                    if (rangeStr.trim()) {
                        const parts = rangeStr.split(/[,ï¼Œ]/);
                        parts.forEach(part => {
                            part = part.trim();
                            if (!part) return;
                            if (part.includes('-')) {
                                const [start, end] = part.split('-').map(s => parseInt(s.trim()));
                                if (!isNaN(start) && !isNaN(end)) {
                                    for (let i = start; i <= end; i++) idsToRun.push(i);
                                }
                            } else {
                                const id = parseInt(part);
                                if (!isNaN(id)) idsToRun.push(id);
                            }
                        });

                        if (idsToRun.length === 0) {
                            alert("æ— æ•ˆçš„ç« èŠ‚èŒƒå›´æ ¼å¼");
                            return;
                        }
                    } else {
                        if (!confirm(`æœªè¾“å…¥èŒƒå›´ï¼Œç¡®å®šè¦ç”Ÿæˆ "${book.name}" çš„å…¨éƒ¨ç« èŠ‚å—ï¼Ÿ`)) return;
                    }

                    const payload = {
                        book_name: book.name,
                        chapter_ids: idsToRun.length > 0 ? idsToRun : undefined,
                        config: {
                            voice: config.value.voice,
                            rate: config.value.rate + "%",
                            volume: config.value.volume + "%",
                            pitch: config.value.pitch || "+0Hz"
                        }
                    };

                    try {
                        await api.post('/start', payload);
                        fetchBooks();
                    } catch (e) {
                        alert("å¯åŠ¨å¤±è´¥: " + e.message);
                    }
                };

                // Actions
                const startSelected = async () => {
                    // Logic: If selection is empty, default to "Select All" FIRST?
                    // Or follow the user request "if empty default all". 
                    // This implies the action itself should select all if nothing is selected.
                    let idsToRun = Array.from(selectedChapters.value);
                    if (idsToRun.length === 0) {
                        if (confirm("æœªé€‰ä¸­ä»»ä½•ç« èŠ‚ï¼Œæ˜¯å¦é»˜è®¤ç”Ÿæˆå…¨éƒ¨ç« èŠ‚ï¼Ÿ")) {
                            idsToRun = chapters.value.map(c => c.id);
                            // Optionally update UI selection too
                            chapters.value.forEach(c => selectedChapters.value.add(c.id));
                        } else {
                            return;
                        }
                    }

                    const payload = {
                        book_name: currentBook.value.name,
                        chapter_ids: idsToRun,
                        config: {
                            voice: config.value.voice,
                            rate: config.value.rate + "%",
                            volume: config.value.volume + "%",
                            pitch: config.value.pitch || "+0Hz"
                        }
                    };
                    try {
                        await api.post('/start', payload);
                        fetchTaskStatus();
                    } catch (e) { alert("å¯åŠ¨å¤±è´¥: " + e.message); }
                };

                const pauseTask = async () => {
                    await api.post(`/pause/${currentBook.value.name}`);
                    fetchTaskStatus();
                };

                const resumeTask = async () => {
                    await api.post(`/resume/${currentBook.value.name}`);
                    fetchTaskStatus();
                };

                const deleteSelected = async () => {
                    if (!confirm(`ç¡®å®šè¦æ¸…ç†é€‰ä¸­çš„ ${selectedChapters.value.size} ä¸ªç« èŠ‚å—ï¼Ÿè¿™ä¼šåˆ é™¤å·²ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚`)) return;

                    try {
                        await api.post(`/clean/${currentBook.value.name}`, {
                            chapter_ids: Array.from(selectedChapters.value)
                        });
                        await fetchChapters();
                        selectedChapters.value.clear();
                    } catch (e) { alert("æ¸…ç†å¤±è´¥: " + e.message); }
                };

                // --- Upload ---
                const handleUpload = async (file) => {
                    if (!file) return;
                    uploading.value = true;
                    const formData = new FormData();
                    formData.append("file", file);
                    try {
                        await api.post('/upload', formData);
                        await fetchBooks();
                    } catch (e) {
                        alert("ä¸Šä¼ å¤±è´¥: " + e.response?.data?.detail || e.message);
                    } finally {
                        uploading.value = false;
                    }
                };
                const handleFileSelect = (e) => handleUpload(e.target.files[0]);
                const handleDrop = (e) => handleUpload(e.dataTransfer.files[0]);

                // --- Helpers ---
                const openFolder = async (bookName) => {
                    await api.post(`/open_folder?book_name=${encodeURIComponent(bookName)}`);
                };

                // Audio Features
                const downloadZip = () => {
                    window.open(`/api/download/${currentBook.value.name}`, '_blank');
                };

                const mergeAudio = async () => {
                    const ids = selectedChapters.value.size > 0 ? Array.from(selectedChapters.value) : null;
                    const msg = ids ? `ç¡®å®šåˆå¹¶é€‰ä¸­çš„ ${ids.length} ä¸ªç« èŠ‚å—ï¼Ÿ` : "ç¡®å®šåˆå¹¶æ‰€æœ‰å·²å®Œæˆçš„éŸ³é¢‘å—ï¼Ÿ";
                    if (!confirm(msg)) return;

                    try {
                        alert("æ­£åœ¨åå°åˆå¹¶ï¼Œè¯·ç¨å€™... å®Œæˆåå°†è‡ªåŠ¨ä¸‹è½½ã€‚");
                        const res = await api.post(`/merge/${currentBook.value.name}`, {
                            book_name: currentBook.value.name,
                            chapter_ids: ids,
                            config: config.value
                        }, { responseType: 'blob' });

                        // Download blob
                        const url = window.URL.createObjectURL(new Blob([res.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', `${currentBook.value.name}_merged.mp3`);
                        document.body.appendChild(link);
                        link.click();
                    } catch (e) {
                        alert("åˆå¹¶å¤±è´¥ (å¯èƒ½æ˜¯æœåŠ¡å™¨æœªå®‰è£… ffmpeg): " + (e.response?.data?.detail || e.message));
                    }
                };

                const previewing = ref(false);

                const testVoice = async () => {
                    if (previewing.value) return;
                    previewing.value = true;
                    try {
                        const voice = config.value.voice;
                        const rate = config.value.rate;
                        const volume = config.value.volume;
                        const pitch = config.value.pitch;

                        // Use new GET endpoint with params
                        const url = `/api/voice/preview/${voice}?rate=${encodeURIComponent(rate)}&volume=${encodeURIComponent(volume)}&pitch=${encodeURIComponent(pitch)}`;

                        // Play directly from URL
                        const audio = new Audio(url);
                        // Add error handling for audio load
                        audio.onerror = (e) => {
                            console.error("Audio playback error", e);
                            alert("è¯•å¬æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æ—¥å¿—ã€‚");
                            previewing.value = false;
                        };
                        audio.onended = () => {
                            previewing.value = false;
                        };
                        await audio.play();
                    } catch (e) {
                        console.error("Voice test failed:", e);
                        alert("è¯•å¬è¯·æ±‚å¤±è´¥: " + e.message);
                        previewing.value = false;
                    }
                    // Note: previewing set to false in onended/onerror
                };

                // Custom Preview Logic
                const customText = ref("");
                const customPreviewing = ref(false);

                const defaultCustomPlaceholder = computed(() => {
                    const v = voices.value.find(v => v.ShortName === config.value.voice);
                    const name = v ? (v.LocalName || v.ShortName.split('-').pop().replace('Neural', '')) : "æˆ‘";
                    return `ä½ å¥½ï¼Œæˆ‘æ˜¯${name}ï¼Œæ‚¨å¯ä»¥è¾“å…¥æ–‡å­—è®©æˆ‘è¯•è¯»ã€‚`;
                });

                const randomTexts = [
                    "å¤©è¡—å°é›¨æ¶¦å¦‚é…¥ï¼Œè‰è‰²é¥çœ‹è¿‘å´æ— ã€‚",
                    "æ®æœ€æ–°æ¶ˆæ¯ï¼Œå¾®è½¯å‘å¸ƒäº†æ–°ä¸€ä»£äººå·¥æ™ºèƒ½è¯­éŸ³æŠ€æœ¯ï¼Œæ•ˆæœæƒŠäººã€‚",
                    "ä½ è‹¥æ˜¯é‚£å«æ³ªçš„å°„æ‰‹ï¼Œæˆ‘ä¾¿æ˜¯é‚£å†³å¿ƒä¸å†é—ªèº²çš„ç™½é¸Ÿã€‚",
                    "ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œé€‚åˆå‡ºå»èµ°èµ°ï¼Œå–æ¯å’–å•¡ã€‚",
                    "ç”Ÿæ´»ä¸æ˜¯çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—å’Œè¿œæ–¹çš„ç”°é‡ã€‚"
                ];

                const setRandomText = () => {
                    customText.value = randomTexts[Math.floor(Math.random() * randomTexts.length)];
                };

                const testCustomVoice = async () => {
                    if (!customText.value) return;
                    if (customPreviewing.value) return;

                    customPreviewing.value = true;
                    try {
                        const res = await api.post('/voice/preview_custom', {
                            text: customText.value,
                            voice: config.value.voice,
                            rate: config.value.rate,
                            volume: config.value.volume,
                            pitch: config.value.pitch
                        }, { responseType: 'blob' });

                        const blob = new Blob([res.data], { type: 'audio/mpeg' });
                        const url = URL.createObjectURL(blob);
                        const audio = new Audio(url);

                        audio.onended = () => {
                            URL.revokeObjectURL(url);
                            customPreviewing.value = false;
                        };
                        audio.onerror = () => {
                            alert("æ’­æ”¾å¤±è´¥");
                            customPreviewing.value = false;
                        }
                        await audio.play();
                    } catch (e) {
                        alert("ç”Ÿæˆå¤±è´¥: " + (e.response?.data?.detail || e.message));
                        customPreviewing.value = false;
                    }
                };

                const previewChapter = async (chapter) => {
                    try {
                        // Show loading state on button? Hard with current iterate.
                        // Just use global generic loading or toast?
                        // For now simple alert if slow?
                        console.log("Previewing chapter:", chapter.title);
                        // Fix: pass correct book_name and chapter_id to backend.
                        // Backend logic: if book_name != "preview" and chapter_id present, it fetches content.
                        const res = await api.post('/preview', {
                            book_name: currentBook.value.name,
                            chapter_id: chapter.id,
                            config: {
                                ...config.value,
                                rate: config.value.rate + "%",
                                volume: config.value.volume + "%",
                                pitch: config.value.pitch || "+0Hz"
                            }
                        }, { responseType: 'blob' });

                        const blob = new Blob([res.data], { type: 'audio/mpeg' });
                        const audio = new Audio(URL.createObjectURL(blob));
                        await audio.play();
                    } catch (e) {
                        console.error("Preview failed:", e);
                        alert("è¯•å¬å¤±è´¥: " + e.message);
                    }
                };

                // Bark Notification Test
                const testBarkNotification = async () => {
                    if (!barkConfig.value.serverUrl || !barkConfig.value.apiKey) {
                        alert("è¯·å…ˆå¡«å†™ Bark æœåŠ¡å™¨åœ°å€å’Œ Key");
                        return;
                    }

                    barkTesting.value = true;
                    try {
                        const res = await api.post('/bark/test', {
                            server_url: barkConfig.value.serverUrl,
                            api_key: barkConfig.value.apiKey
                        });

                        if (res.data.success) {
                            alert("âœ… " + res.data.message);
                        } else {
                            alert("âŒ " + res.data.message);
                        }
                    } catch (e) {
                        console.error("Bark test failed:", e);
                        alert("æµ‹è¯•å¤±è´¥: " + (e.response?.data?.detail || e.message));
                    } finally {
                        barkTesting.value = false;
                    }
                };

                // Notifications
                const requestNotification = () => {
                    if ("Notification" in window && Notification.permission !== "granted") {
                        Notification.requestPermission();
                    }
                };

                // Watch status for notifications
                watch(() => currentTaskStatus.value, (newVal, oldVal) => {
                    if (oldVal.is_running && !newVal.is_running) {
                        // Finished?
                        // Check if all completed or any failed? 
                        // Simplified: Just notify "Task Stopped/Finished"
                        if (Notification.permission === "granted") {
                            new Notification("Edge TTS", { body: `ä»»åŠ¡å·²å·²åœæ­¢æˆ–å®Œæˆ: ${currentBook.value?.name}` });
                        }
                    }
                }, { deep: true });

                // Watch concurrency
                watch(concurrency, async (newVal) => {
                    try {
                        await api.post(`/concurrency?limit=${newVal}`);
                    } catch (e) { console.error(e); }
                });

                const statusClass = (status) => {
                    switch (status) {
                        case 'completed': return 'bg-green-900 text-green-300';
                        case 'processing': return 'bg-blue-900 text-blue-300 animate-pulse';
                        default: return 'bg-gray-700 text-gray-300';
                    }
                };

                const progressPercent = (book) => {
                    if (book.total === 0) return 0;
                    return Math.round((book.completed / book.total) * 100);
                };

                // ==================== é…ç½®åŠ è½½å’Œä¿å­˜ ====================

                // Version Check Methods
                const checkVersion = async () => {
                    try {
                        const res = await api.get('/version/info');
                        if (res.data.update_available && res.data.update_info) {
                            updateInfo.value = res.data.update_info;
                            showUpdateModal.value = true;
                        }
                    } catch (e) {
                        console.error('ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥:', e);
                    }
                };

                const dismissUpdate = async () => {
                    try {
                        await api.post('/version/dismiss');
                        showUpdateModal.value = false;
                        updateInfo.value = null;
                    } catch (e) {
                        console.error('å¿½ç•¥æ›´æ–°å¤±è´¥:', e);
                    } finally {
                        showUpdateModal.value = false;
                    }
                };


                // loadConfigFromBackend removed - replaced by reloadConfig(true) on startup


                const saveAsDefault = async () => {
                    if (!confirm('ç¡®å®šå°†å½“å‰è®¾ç½®ä¿å­˜ä¸ºé»˜è®¤é…ç½®å—?\n\nä¿å­˜å,ä¸‹æ¬¡å¯åŠ¨åº”ç”¨å°†ä½¿ç”¨è¿™äº›å‚æ•°ä½œä¸ºé»˜è®¤å€¼ã€‚')) {
                        return;
                    }

                    saving.value = true;
                    try {
                        const payload = {
                            tts: {
                                default_voice: config.value.voice,
                                default_rate: config.value.rate,
                                default_volume: config.value.volume,
                                default_pitch: config.value.pitch,
                                concurrency_limit: parseInt(concurrency.value),
                                max_retries: parseInt(maxRetries.value),
                                timeout: parseInt(timeout.value),
                                max_chars: parseInt(maxChars.value)
                            },
                            bark: {
                                enabled: barkConfig.value.enabled,
                                server_url: barkConfig.value.serverUrl,
                                api_key: barkConfig.value.apiKey
                            }
                        };

                        const res = await api.post('/config', payload);

                        if (res.data.success) {
                            // å¼ºåˆ¶é‡è½½é…ç½®ä»¥ç¡®ä¿åç«¯å†…å­˜åŒæ­¥
                            try {
                                await api.post('/config/reload');
                            } catch (e) {
                                console.error("Auto reload failed", e);
                            }
                            alert('âœ… é…ç½®å·²ä¿å­˜!\n\n' + res.data.message);
                        } else {
                            alert('âŒ ä¿å­˜å¤±è´¥: ' + (res.data.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (e) {
                        console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
                        let errorMsg = 'ä¿å­˜å¤±è´¥';
                        if (e.response?.data?.detail) {
                            if (typeof e.response.data.detail === 'object') {
                                // éªŒè¯é”™è¯¯
                                const errors = e.response.data.detail.errors || {};
                                errorMsg = 'å‚æ•°éªŒè¯å¤±è´¥:\n\n';
                                for (const [field, msg] of Object.entries(errors)) {
                                    errorMsg += `- ${field}: ${msg}\n`;
                                }
                            } else {
                                errorMsg = e.response.data.detail;
                            }
                        }
                        alert('âŒ ' + errorMsg);
                    } finally {
                        saving.value = false;
                    }
                };

                // Lifecycle
                let pollTimer;
                const startPolling = () => {
                    pollTimer = setInterval(() => {
                        if (viewMode.value === 'list') {
                            fetchBooks();
                        } else {
                            fetchChapters();
                            fetchTaskStatus();
                            fetchLogs();
                        }
                    }, 2000);
                };

                onMounted(async () => {
                    // Force reload config from disk on startup to ensure fresh state
                    await reloadConfig(true);
                    await fetchBooks();
                    // fetchVoices removed - reloadConfig handles voice list update

                    startPolling();

                    // å»¶è¿Ÿæ£€æŸ¥ç‰ˆæœ¬æ›´æ–°
                    setTimeout(checkVersion, 3000);
                });

                onBeforeUnmount(() => {
                    clearInterval(pollTimer);
                });

                return {
                    // State
                    viewMode, currentBook, books, chapters, selectedChapters, voices,
                    currentTaskStatus, currentChapterIds,
                    uploading, fileInput,
                    rateVal, volumeVal, pitchVal, concurrency, config,
                    barkConfig, barkTesting,
                    showAdvanced, maxRetries, timeout, maxChars, saving,
                    reloadingConfig, lastReloadTime,
                    updateInfo, showUpdateModal,
                    isAllSelected, rangeInput, quickRanges,
                    showLogs, logs, logContainer,
                    customText, customPreviewing, defaultCustomPlaceholder, previewing,

                    // Methods
                    fetchBooks, fetchVoices, updateConcurrency, fetchLogs,
                    enterDetail, fetchChapters, fetchTaskStatus,
                    handleUpload, handleFileSelect, handleDrop,
                    toggleChapter, toggleSelectAll, applyRangeSelection, handleQuickStart,
                    deleteSelected, startSelected, pauseTask, resumeTask,
                    resetConfig, reloadConfig,
                    testVoice, previewChapter, testCustomVoice, setRandomText,
                    downloadZip, mergeAudio, openFolder,
                    testBarkNotification, saveAsDefault,
                    checkVersion, dismissUpdate,
                    statusClass, progressPercent
                };
            }
        }).mount('#app');
    </script>
</body>

</html>