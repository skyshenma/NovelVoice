version: '3.8'

services:
  novelvoice:
    # 本地开发版本 - 使用本地构建
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    image: novelvoice:local-dev

    container_name: novelvoice-dev
    restart: unless-stopped

    ports:
      - "8000:8000"

    volumes:
      # 数据持久化
      - ../../data:/app/data
      # 数据库持久化
      - ../../data/db:/app/data/db
      # 时区同步
      - /etc/localtime:/etc/localtime:ro

      # 本地开发: 挂载源代码以支持热重载 (默认开启)
      - ../../app:/app/app
      - ../../static:/app/static
      # 挂载配置目录 (方便本地编辑)
      - ../../data/config:/app/data/config

    # 热重载命令
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

    # 从 .env 文件加载环境变量
    env_file:
      - ../../.env

    environment:
      # 应用基础配置
      - NOVELVOICE_DATA_DIR=/app/data
      - NOVELVOICE_DB_DIR=/app/data/db
      - ENVIRONMENT=development
      # 时区设置
      - TZ=America/Los_Angeles

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/books" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
