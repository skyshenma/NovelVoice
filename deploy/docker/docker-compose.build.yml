version: '3.8'

services:
  novelvoice:
    # 使用 Docker Hub 镜像
    image: skyshenma2024/novelvoice:latest

    # 或者本地构建
    # build:
    #   context: ../..
    #   dockerfile: deploy/docker/Dockerfile
    # image: novelvoice:latest

    container_name: novelvoice
    restart: unless-stopped

    ports:
      - "8000:8000"

    volumes:
      # Data persistence
      - ../../data:/data
      - ../../app:/app/app
      - ../../static:/app/static
      - ../../docs:/app/docs
      # Config file (optional, for easy editing)
      # - ./data/config/config.yml:/data/config/config.yml
      # Timezone Sync
      - /etc/localtime:/etc/localtime:ro
      # Load environment variables from .env file (optional)
      # env_file:
      #   - .env

    environment:
      # Application settings
      - NOVELVOICE_DATA_DIR=/data
      - NOVELVOICE_HOST=0.0.0.0
      - NOVELVOICE_PORT=8000
      # Optional: Override config values
      # - NOVELVOICE_TTS_VOICE=zh-CN-XiaoxiaoNeural
      # - NOVELVOICE_TTS_CONCURRENCY=2
      # - NOVELVOICE_TTS_MAX_RETRIES=3
      # - NOVELVOICE_BARK_ENABLED=false
      # - NOVELVOICE_BARK_API_KEY=your_key_here
      # 应用版本 (可选, 用于显式覆盖, 默认会自动从 docs/changelog.md 提取)
      # - NOVELVOICE_VERSION=1.4.1

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/books" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Named volumes for better management
# volumes:
#   novelvoice-data:
#     driver: local
