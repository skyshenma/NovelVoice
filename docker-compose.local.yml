version: '3.8'

services:
  novelvoice:
    # 本地开发版本 - 使用本地构建
    build:
      context: .
      dockerfile: Dockerfile
    image: novelvoice:local-dev
    
    container_name: novelvoice-local
    restart: unless-stopped

    ports:
      - "8000:8000"

    volumes:
      # 数据持久化
      - ./data:/data
      
      # 本地开发: 挂载源代码以支持热重载 (可选)
      # 如果需要在容器内实时看到代码修改，取消下面的注释
      # - ./app:/app/app:ro
      # - ./static:/app/static:ro
      
      # 配置文件 (方便本地编辑)
      - ./data/config/config.yml:/data/config/config.yml

    # 从 .env 文件加载环境变量 (如果存在)
    env_file:
      - .env

    environment:
      # 应用基础配置
      - NOVELVOICE_DATA_DIR=/data
      - NOVELVOICE_HOST=0.0.0.0
      - NOVELVOICE_PORT=8000
      
      # 开发环境标识
      - ENVIRONMENT=development
      
      # TTS 配置 (可根据需要调整)
      - NOVELVOICE_TTS_VOICE=zh-CN-XiaoxiaoNeural
      - NOVELVOICE_TTS_RATE=+0%
      - NOVELVOICE_TTS_CONCURRENCY=2
      - NOVELVOICE_TTS_MAX_RETRIES=3
      
      # Bark 通知配置 (开发环境可以禁用)
      - NOVELVOICE_BARK_ENABLED=false
      # - NOVELVOICE_BARK_API_KEY=your_key_here
      # - NOVELVOICE_BARK_SERVER_URL=https://api.day.app
      # - NOVELVOICE_BARK_WEB_BASE_URL=http://localhost:8000

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/books"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 开发环境资源限制 (相对宽松)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    # 日志配置 - 开发环境保留更多日志
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# 可选: 如果需要数据库等其他服务，可以在这里添加
# services:
#   redis:
#     image: redis:alpine
#     container_name: novelvoice-redis
#     ports:
#       - "6379:6379"
