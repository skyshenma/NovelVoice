# 更新日志

NovelVoice 的所有重要更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/),
并且本项目遵循 [语义化版本控制](https://semver.org/lang/zh-CN/)。

## [未发布]

## [1.4.0] - 2026-02-10

### ✨ 新增功能 (New Features)
- **书籍打包系统重构**:
  - 全新基于磁盘的流式打包系统，解决大文件内存溢出问题。
  - 支持后台异步打包任务，不阻塞主线程。
  - 新增打包进度实时显示与状态反馈 (打包中/完成/取消)。
  - 新增打包任务取消功能。
  - 启动时自动清理残留的临时文件。
- **UI/UX 体验升级**:
  - **书籍列表**: 恢复宽屏单列显示模式，超大屏自适应双列，优化移动端展示。
  - **实时反馈**: WebSocket 连接状态实时监控，断线重连提示优化。
  - **全局通知**: 新增全局错误提示 (Toast)，后端日志错误直接推送到前端显示。
  - **防抖保护**: 打包/取消按钮增加防抖逻辑，防止重复点击。
  - **焦点同步**: 窗口重新获得焦点时自动同步书籍状态。
- **Docker 部署优化**:
  - 优化 Docker 镜像构建流程。
  - 解决容器内 WebSocket 连接与端口映射问题。

### 🐛 问题修复 (Bug Fixes)
- 修复了 `get_book_status` 中 `zip_size_str` 变量未定义的错误。
- 修复了前端 WebSocket 连接状态判断逻辑，解决了“连接断开”误报问题。
- 修复了书籍列表在移动端和桌面端布局不一致的问题。
- 修正了 WebSocket 推送地址配置。

### 🔧 系统优化 (Improvements)
- 优化了日志系统，支持更详细的错误追踪。
- 统一了前后端中英文案，确保用户界面均为中文。
- 增加了磁盘空间检查与文件名安全过滤机制。

## [1.3.2] - 2026-02-09

### Added
- **版本显示与自动化**:
  - UI 侧边栏新增版本信息展示，支持显示当前运行版本。
  - 集成 GitHub API，支持实时检查 `skyshenma/NovelVoice` 仓库的最新发布版本。
  - 实现版本号自动化检测：系统自动从 `docs/changelog.md` 提取版本号，告别硬编码。
- **音频合并升级**:
  - 引入 **FFmpeg Concat Demuxer**：长章节合并逻辑从二进制追加升级为 FFmpeg 方案，大幅提升音频文件的标准兼容性（支持正确的时长显示与拖动）。
- **Docker 部署增强**:
  - 基础镜像更新：Docker 镜像现已内置 `ffmpeg` 运行依赖。
  - 环境变量支持：新增 `NOVELVOICE_VERSION` 用于在容器化部署时显式指定版本。
  - 本地开发优化：`docker-compose.dev.yml` 支持代码挂载、热重载及 `docs/` 目录同步以便自动检测版本。

## [1.3.1] - 2026-02-09

### Fixed
- **TTS 参数清理**: 优化了 `TTSProcessor` 中的 `clean_param` 逻辑，修复了语速/音量调整时可能出现的重复百分号（如 `+0%%`）导致合成失败的问题。
- **预览接口同步**: 同步更新了试听预览接口，确保参数传递的一致性。

### Changed
- **本地开发环境优化**: 重构了 `docker-compose.dev.yml`，默认支持代码挂载热重载（Hot-reload），并优化了数据目录挂载结构。

## [1.3.0] - 2026-02-09

### Added
- **SQLite 数据库**: 引入 SQLite 替代 JSON 文件进行任务管理，显著提升大章节并发处理的稳定性，并解决文件损坏风险。
- **自动数据迁移**: 启动时自动将旧版的 `tasks.json` 数据同步至 SQLite 数据库。
- **Docker 部署优化**: 优化了 Docker Compose 配置，明确了 `TZ` 环境变量与 `/etc/localtime` 挂载的优先级关系。
- **双层部署模型**: 在根目录提供一键运行的 `docker-compose.yml`（直接拉取镜像），并将高级构建与开发工具移入 `deploy/docker/`。

### Changed
- **项目结构重组**: 将根目录的所有 Markdown 文档移至 `docs/` 文件夹，清理根目录杂碎。
- **链接与路径同步**: 全面更新了 `README.md` 及所有文档中的链接和 Docker 运行指令。

### Fixed
- **后台任务静默失败**: 修复了 `app/api/endpoints/tasks.py` 中由于变量遮蔽导致的后台 TTS 任务无法正常启动的问题。
- **配置冗余**: 移除了 `config.yml` 中重复的 `logging` 配置节。

### Removed
- **环境清理**: 删除了所有测试残留文件、macOS 系统元数据 (`.DS_Store`) 以及 Python 缓存目录。

## [1.2.2] - 2024-03-21

### Added
- 支持更多语言和语音。
- 增强了进度显示。

## [1.2.1] - 2024-03-20

### Fixed
- 修复了 Docker 环境下的路径配置问题。

## [1.2.0] - 2024-03-15

### Changed
- 重构配置系统，全面移除硬编码值。
